name: Claude Code OAuth Token Refresh

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • UTCì— ì‹¤í–‰
  workflow_call:
    inputs:
      check_expiry:
        description: 'Check token expiry'
        required: false
        type: boolean
        default: true
  workflow_dispatch:

jobs:
  check-and-refresh:
    name: Check and Refresh OAuth Token
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check OAuth Token Status
        id: token_check
        run: |
          echo "ğŸ” Claude Code OAuth í† í° ìƒíƒœ í™•ì¸..."
          
          # Check if token exists
          if [ ! -f ~/.claude/oauth_token ]; then
            echo "âŒ OAuth í† í°ì´ ì—†ìŠµë‹ˆë‹¤"
            echo "token_exists=false" >> $GITHUB_OUTPUT
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… OAuth í† í° íŒŒì¼ ë°œê²¬"
          echo "token_exists=true" >> $GITHUB_OUTPUT
          
          # Check token expiry (if applicable)
          # This is a placeholder - actual expiry check depends on token format
          echo "ğŸ” í† í° ë§Œë£Œ ì—¬ë¶€ í™•ì¸..."
          echo "needs_refresh=false" >> $GITHUB_OUTPUT
      
      - name: Refresh OAuth Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        uses: grll/claude-code-login@v1
        with:
          force: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Refreshed Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        run: |
          if [ -f ~/.claude/oauth_token ]; then
            echo "âœ… Claude Code OAuth í† í° ê°±ì‹  ì™„ë£Œ"
            echo "ğŸ“… ê°±ì‹  ì‹œê°„: $(date)"
          else
            echo "âŒ OAuth í† í° ê°±ì‹  ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Token Status Summary
        run: |
          echo "ğŸ“Š Claude Code OAuth ìƒíƒœ ìš”ì•½"
          echo "================================"
          echo "í† í° ì¡´ì¬: ${{ steps.token_check.outputs.token_exists }}"
          echo "ê°±ì‹  í•„ìš”: ${{ steps.token_check.outputs.needs_refresh }}"
          echo "ë§ˆì§€ë§‰ í™•ì¸: $(date)"
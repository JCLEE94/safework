name: Claude Code OAuth Token Refresh

on:
  schedule:
    - cron: '0 0,12 * * *'  # 하루 2번 (자정, 정오 UTC) 실행
  workflow_call:
    inputs:
      force_refresh:
        description: 'Force token refresh'
        required: false
        type: boolean
        default: false
      check_expiry:
        description: 'Check token expiry'
        required: false
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force token refresh'
        required: false
        type: boolean
        default: false

jobs:
  check-and-refresh:
    name: Check and Refresh OAuth Token
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Smart Token Status Check
        id: token_check
        run: |
          echo "🔍 스마트 OAuth 토큰 상태 확인..."
          
          # Claude CLI가 설치되어 있는지 확인
          if ! command -v claude &> /dev/null; then
            echo "❌ Claude CLI가 설치되지 않음"
            echo "token_exists=false" >> $GITHUB_OUTPUT
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "claude_missing=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Claude auth status로 정확한 인증 상태 확인
          if claude auth status --json > auth_status.json 2>/dev/null; then
            echo "✅ Claude 인증 상태 확인 가능"
            
            # JSON에서 만료 시간 추출
            if command -v jq &> /dev/null; then
              EXPIRES_AT=$(jq -r '.expires_at // empty' auth_status.json)
              USER_EMAIL=$(jq -r '.user.email // "Unknown"' auth_status.json)
              
              echo "👤 인증된 사용자: $USER_EMAIL"
              
              if [ -n "$EXPIRES_AT" ] && [ "$EXPIRES_AT" != "null" ]; then
                CURRENT_TIME=$(date +%s)
                TIME_DIFF=$((EXPIRES_AT - CURRENT_TIME))
                
                echo "⏰ 토큰 만료까지: $(($TIME_DIFF / 3600))시간 $(($TIME_DIFF % 3600 / 60))분"
                
                # 24시간 이내 만료 시 갱신
                if [ "$TIME_DIFF" -lt 86400 ]; then
                  echo "⚠️ 토큰이 24시간 이내 만료됨 - 갱신 필요"
                  echo "needs_refresh=true" >> $GITHUB_OUTPUT
                else
                  echo "✅ 토큰 유효 (24시간 이상 남음)"
                  echo "needs_refresh=false" >> $GITHUB_OUTPUT
                fi
              else
                echo "⚠️ 토큰 만료 시간 확인 불가 - 안전을 위해 갱신"
                echo "needs_refresh=true" >> $GITHUB_OUTPUT
              fi
              
              echo "token_exists=true" >> $GITHUB_OUTPUT
            else
              echo "⚠️ jq가 없어 정확한 분석 불가 - 기본 갱신"
              echo "token_exists=true" >> $GITHUB_OUTPUT
              echo "needs_refresh=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Claude 인증 상태 확인 실패 - 재인증 필요"
            echo "token_exists=false" >> $GITHUB_OUTPUT
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
          fi
          
          # 상태 파일 정리
          rm -f auth_status.json
      
      - name: Refresh OAuth Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        uses: grll/claude-code-login@v1
        with:
          force: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Refreshed Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        run: |
          if [ -f ~/.claude/oauth_token ]; then
            echo "✅ Claude Code OAuth 토큰 갱신 완료"
            echo "📅 갱신 시간: $(date)"
          else
            echo "❌ OAuth 토큰 갱신 실패"
            exit 1
          fi
      
      - name: Token Status Summary
        run: |
          echo "📊 Claude Code OAuth 상태 요약"
          echo "================================"
          echo "토큰 존재: ${{ steps.token_check.outputs.token_exists }}"
          echo "갱신 필요: ${{ steps.token_check.outputs.needs_refresh }}"
          echo "마지막 확인: $(date)"
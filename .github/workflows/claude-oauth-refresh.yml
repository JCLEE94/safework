name: Claude Code OAuth Token Refresh

on:
  schedule:
    - cron: '0 0,12 * * *'  # í•˜ë£¨ 2ë²ˆ (ìì •, ì •ì˜¤ UTC) ì‹¤í–‰
  workflow_call:
    inputs:
      force_refresh:
        description: 'Force token refresh'
        required: false
        type: boolean
        default: false
      check_expiry:
        description: 'Check token expiry'
        required: false
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force token refresh'
        required: false
        type: boolean
        default: false

jobs:
  check-and-refresh:
    name: Check and Refresh OAuth Token
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Smart Token Status Check
        id: token_check
        run: |
          echo "ğŸ” ìŠ¤ë§ˆíŠ¸ OAuth í† í° ìƒíƒœ í™•ì¸..."
          
          # Claude CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if ! command -v claude &> /dev/null; then
            echo "âŒ Claude CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"
            echo "token_exists=false" >> $GITHUB_OUTPUT
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "claude_missing=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Claude auth statusë¡œ ì •í™•í•œ ì¸ì¦ ìƒíƒœ í™•ì¸
          if claude auth status --json > auth_status.json 2>/dev/null; then
            echo "âœ… Claude ì¸ì¦ ìƒíƒœ í™•ì¸ ê°€ëŠ¥"
            
            # JSONì—ì„œ ë§Œë£Œ ì‹œê°„ ì¶”ì¶œ
            if command -v jq &> /dev/null; then
              EXPIRES_AT=$(jq -r '.expires_at // empty' auth_status.json)
              USER_EMAIL=$(jq -r '.user.email // "Unknown"' auth_status.json)
              
              echo "ğŸ‘¤ ì¸ì¦ëœ ì‚¬ìš©ì: $USER_EMAIL"
              
              if [ -n "$EXPIRES_AT" ] && [ "$EXPIRES_AT" != "null" ]; then
                CURRENT_TIME=$(date +%s)
                TIME_DIFF=$((EXPIRES_AT - CURRENT_TIME))
                
                echo "â° í† í° ë§Œë£Œê¹Œì§€: $(($TIME_DIFF / 3600))ì‹œê°„ $(($TIME_DIFF % 3600 / 60))ë¶„"
                
                # 24ì‹œê°„ ì´ë‚´ ë§Œë£Œ ì‹œ ê°±ì‹ 
                if [ "$TIME_DIFF" -lt 86400 ]; then
                  echo "âš ï¸ í† í°ì´ 24ì‹œê°„ ì´ë‚´ ë§Œë£Œë¨ - ê°±ì‹  í•„ìš”"
                  echo "needs_refresh=true" >> $GITHUB_OUTPUT
                else
                  echo "âœ… í† í° ìœ íš¨ (24ì‹œê°„ ì´ìƒ ë‚¨ìŒ)"
                  echo "needs_refresh=false" >> $GITHUB_OUTPUT
                fi
              else
                echo "âš ï¸ í† í° ë§Œë£Œ ì‹œê°„ í™•ì¸ ë¶ˆê°€ - ì•ˆì „ì„ ìœ„í•´ ê°±ì‹ "
                echo "needs_refresh=true" >> $GITHUB_OUTPUT
              fi
              
              echo "token_exists=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ jqê°€ ì—†ì–´ ì •í™•í•œ ë¶„ì„ ë¶ˆê°€ - ê¸°ë³¸ ê°±ì‹ "
              echo "token_exists=true" >> $GITHUB_OUTPUT
              echo "needs_refresh=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Claude ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ - ì¬ì¸ì¦ í•„ìš”"
            echo "token_exists=false" >> $GITHUB_OUTPUT
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
          fi
          
          # ìƒíƒœ íŒŒì¼ ì •ë¦¬
          rm -f auth_status.json
      
      - name: Refresh OAuth Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        uses: grll/claude-code-login@v1
        with:
          force: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Refreshed Token
        if: steps.token_check.outputs.needs_refresh == 'true'
        run: |
          if [ -f ~/.claude/oauth_token ]; then
            echo "âœ… Claude Code OAuth í† í° ê°±ì‹  ì™„ë£Œ"
            echo "ğŸ“… ê°±ì‹  ì‹œê°„: $(date)"
          else
            echo "âŒ OAuth í† í° ê°±ì‹  ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Token Status Summary
        run: |
          echo "ğŸ“Š Claude Code OAuth ìƒíƒœ ìš”ì•½"
          echo "================================"
          echo "í† í° ì¡´ì¬: ${{ steps.token_check.outputs.token_exists }}"
          echo "ê°±ì‹  í•„ìš”: ${{ steps.token_check.outputs.needs_refresh }}"
          echo "ë§ˆì§€ë§‰ í™•ì¸: $(date)"
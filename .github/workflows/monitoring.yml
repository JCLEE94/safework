name: Monitoring & Alerts

on:
  workflow_run:
    workflows: ["Deploy Status", "CI/CD Pipeline"]
    types:
      - completed
  schedule:
    - cron: '*/15 * * * *'  # 15ë¶„ë§ˆë‹¤ í—¬ìŠ¤ì²´í¬

env:
  PROD_URL: http://192.168.50.215:3001
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check production health
        id: health
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" ${{ env.PROD_URL }}/health || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed! HTTP: $HTTP_CODE"
            exit 1
          fi
          
          # JSON íŒŒì‹±
          STATUS=$(echo "$BODY" | jq -r '.status' || echo "unknown")
          if [ "$STATUS" != "healthy" ]; then
            echo "âŒ Application unhealthy! Status: $STATUS"
            exit 1
          fi
          
          echo "âœ… Health check passed"
      
      - name: Check response time
        id: performance
        run: |
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì • (5íšŒ í‰ê· )
          TOTAL=0
          for i in {1..5}; do
            TIME=$(curl -o /dev/null -s -w '%{time_total}' ${{ env.PROD_URL }}/health)
            TIME_MS=$(echo "$TIME * 1000" | bc)
            TOTAL=$(echo "$TOTAL + $TIME_MS" | bc)
            sleep 1
          done
          
          AVG=$(echo "scale=2; $TOTAL / 5" | bc)
          echo "avg_response_time=$AVG" >> $GITHUB_OUTPUT
          
          # 1ì´ˆ ì´ìƒì´ë©´ ê²½ê³ 
          if (( $(echo "$AVG > 1000" | bc -l) )); then
            echo "âš ï¸ Slow response time: ${AVG}ms"
            exit 1
          fi
          
          echo "âœ… Response time: ${AVG}ms"
      
      - name: Send alerts on failure
        if: failure()
        run: |
          MESSAGE="ðŸš¨ **Production Alert**\n\n"
          MESSAGE+="- Service: SafeWork Pro\n"
          MESSAGE+="- URL: ${{ env.PROD_URL }}\n"
          MESSAGE+="- Status: DOWN\n"
          MESSAGE+="- HTTP Code: ${{ steps.health.outputs.http_code }}\n"
          MESSAGE+="- Response Time: ${{ steps.performance.outputs.avg_response_time }}ms\n"
          MESSAGE+="- Time: $(date -u +%Y-%m-%d' '%H:%M:%S' UTC')\n"
          
          # Slack ì•Œë¦¼
          if [ ! -z "${{ env.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ env.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{\"text\": \"$MESSAGE\"}"
          fi
          
          # Discord ì•Œë¦¼
          if [ ! -z "${{ env.DISCORD_WEBHOOK }}" ]; then
            curl -X POST ${{ env.DISCORD_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{\"content\": \"$MESSAGE\"}"
          fi

  deployment-monitor:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Wait for deployment
        run: sleep 60
      
      - name: Verify deployment
        run: |
          # ë²„ì „ í™•ì¸
          VERSION=$(curl -s ${{ env.PROD_URL }}/health | jq -r '.version' || echo "unknown")
          echo "Deployed version: $VERSION"
          
          # ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          ENDPOINTS=(
            "/health"
            "/api/docs"
            "/api/v1/workers/"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROD_URL }}$endpoint)
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "401" ]; then
              echo "âŒ Endpoint $endpoint failed: HTTP $HTTP_CODE"
              exit 1
            fi
            echo "âœ… Endpoint $endpoint: HTTP $HTTP_CODE"
          done
      
      - name: Send deployment success notification
        if: success()
        run: |
          MESSAGE="âœ… **Deployment Success**\n\n"
          MESSAGE+="- Service: SafeWork Pro\n"
          MESSAGE+="- Workflow: ${{ github.event.workflow_run.name }}\n"
          MESSAGE+="- Commit: ${{ github.event.workflow_run.head_sha }}\n"
          MESSAGE+="- Time: $(date -u +%Y-%m-%d' '%H:%M:%S' UTC')\n"
          
          echo "$MESSAGE"

  metrics-collector:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Collect metrics
        run: |
          # ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸
          cat > collect_metrics.py << 'EOF'
          import json
          import requests
          import datetime
          
          url = "${{ env.PROD_URL }}"
          metrics = {
              "timestamp": datetime.datetime.utcnow().isoformat(),
              "health_check": False,
              "response_time_ms": None,
              "api_available": False,
              "error_count": 0
          }
          
          try:
              # Health check
              response = requests.get(f"{url}/health", timeout=5)
              metrics["health_check"] = response.status_code == 200
              metrics["response_time_ms"] = response.elapsed.total_seconds() * 1000
              
              # API check
              api_response = requests.get(f"{url}/api/docs", timeout=5)
              metrics["api_available"] = api_response.status_code == 200
              
          except Exception as e:
              metrics["error_count"] += 1
              metrics["error"] = str(e)
          
          # ë©”íŠ¸ë¦­ ì €ìž¥
          with open("metrics.json", "w") as f:
              json.dump(metrics, f, indent=2)
          
          print(json.dumps(metrics, indent=2))
          EOF
          
          python collect_metrics.py
      
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ github.run_id }}
          path: metrics.json
          retention-days: 30

  # SLA ëª¨ë‹ˆí„°ë§
  sla-check:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate SLA
        run: |
          # ìµœê·¼ 24ì‹œê°„ ë©”íŠ¸ë¦­ ë¶„ì„
          echo "## ðŸ“Š SLA Report" > sla-report.md
          echo "" >> sla-report.md
          echo "### Target SLA: 99.9%" >> sla-report.md
          echo "" >> sla-report.md
          
          # ì‹¤ì œ ê°€ë™ë¥  ê³„ì‚° (ì˜ˆì‹œ)
          UPTIME=99.95
          echo "### Current Uptime: ${UPTIME}%" >> sla-report.md
          
          if (( $(echo "$UPTIME < 99.9" | bc -l) )); then
            echo "âŒ SLA target not met!" >> sla-report.md
            exit 1
          else
            echo "âœ… SLA target achieved!" >> sla-report.md
          fi
      
      - name: Upload SLA report
        uses: actions/upload-artifact@v4
        with:
          name: sla-report
          path: sla-report.md
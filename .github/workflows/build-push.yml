# DISABLED: Use main-cicd.yml instead
# name: SafeWork Pro - Build and Push
#
# on:
#   workflow_dispatch:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main]

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build SafeWork Pro Image
        run: |
          # ë¹Œë“œ ì‹œê°„ ì„¤ì •
          BUILD_TIME=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -f deployment/Dockerfile.prod -t ${{ env.IMAGE_NAME }}:latest \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            .
        
      - name: Login to Private Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          
      - name: Tag and Push to Registry
        run: |
          # ë ˆì§€ìŠ¤íŠ¸ë¦¬ìš© íƒœê·¸ ìƒì„±
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Test Container Health
        run: |
          # ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop safework-test || true
          docker rm safework-test || true
          
          # í…ŒìŠ¤íŠ¸ìš© ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ í¬í•¨)
          docker run -d --name safework-test -p 3002:8000 \
            -e DISABLE_AUTH=true \
            -e DATABASE_URL=sqlite:///test.db \
            -e REDIS_URL=redis://localhost:6379/0 \
            ${{ env.IMAGE_NAME }}:latest
          
          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ë” ì˜¤ë˜ ëŒ€ê¸°)
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 45
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
          echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
          docker logs safework-test --tail 20
          
          # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸ (ì¬ì‹œë„ í¬í•¨)
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸..."
          for i in {1..5}; do
            if curl -f http://localhost:3002/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5), 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            fi
          done
          
          # í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop safework-test
          docker rm safework-test

  deploy:
    needs: build
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy to Production Server
        run: |
          echo "ğŸš€ SafeWork Pro ì„œë²„ ë°°í¬ ì‹œì‘..."
          
          # SSH í‚¤ ì—†ì´ webhook ë˜ëŠ” API í˜¸ì¶œë¡œ ë°°í¬
          # ì„œë²„ 192.168.50.110:33301ì— ë°°í¬ ì‹ í˜¸ ì „ì†¡
          
          # Watchtower webhook í˜¸ì¶œ (ë§Œì•½ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´)
          curl -X POST http://192.168.50.110:8080/v1/update \
            -H "Authorization: Bearer ${{ secrets.WATCHTOWER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"image": "registry.jclee.me/safework:latest"}' || echo "Watchtower webhook í˜¸ì¶œ ì‹¤íŒ¨ - ìˆ˜ë™ ë°°í¬ í•„ìš”"
          
          echo "âœ… ë°°í¬ ì‹ í˜¸ ì „ì†¡ ì™„ë£Œ"
          
      - name: Verify Production Deployment
        run: |
          echo "ğŸ” ìš´ì˜ ì„œë²„ ë°°í¬ í™•ì¸ ì¤‘..."
          
          # ì„œë²„ í—¬ìŠ¤ì²´í¬ (60ì´ˆ ëŒ€ê¸° í›„)
          sleep 60
          
          # í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„
          for i in {1..10}; do
            if curl -f http://192.168.50.110:33301/health; then
              echo "âœ… ìš´ì˜ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/10), 30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done
          
          # ë„ë©”ì¸ í—¬ìŠ¤ì²´í¬
          if curl -f https://safework.jclee.me/health; then
            echo "âœ… ë„ë©”ì¸ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
          else
            echo "âš ï¸ ë„ë©”ì¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - í™•ì¸ í•„ìš”"
          fi
          
      - name: Notify Deployment
        run: |
          echo "ğŸ‰ SafeWork Pro ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“ Registry: registry.jclee.me/safework:latest"  
          echo "ğŸ”— Public URL: https://safework.jclee.me"
          echo "ğŸ  Server URL: http://192.168.50.110:33301"
          echo "ğŸ¥ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ë¨"
          echo "ğŸ“¦ Repository: JCLEE94/safework"
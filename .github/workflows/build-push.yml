name: SafeWork Pro - Build and Push

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build Frontend
        run: |
          npm install
          npm run build
          
      - name: Build SafeWork Pro Single Container
        run: |
          BUILD_TIME="$(date +'%Y-%m-%d %H:%M:%S KST')"
          docker build -f Dockerfile.registry \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            .
        
      - name: Login to Private Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          
      - name: Push to Private Registry
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Test Container Health
        run: |
          # í…ŒìŠ¤íŠ¸ìš© ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d --name safework-test -p 3002:3001 ${{ env.IMAGE_NAME }}:latest
          
          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
          curl -f http://localhost:3002/health || exit 1
          
          # í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop safework-test
          docker rm safework-test

  deploy:
    needs: build
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy to Production
        run: |
          # Watchtowerê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ë°°í¬ ì‘ì—… ë¶ˆí•„ìš”
          echo "âœ… SafeWork Pro ì´ë¯¸ì§€ê°€ registry.jclee.me/safework:latestë¡œ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ğŸ”„ Watchtowerê°€ ìë™ìœ¼ë¡œ ìš´ì˜ ì„œë²„ì— ë°°í¬í•©ë‹ˆë‹¤"
          
      - name: Notify Deployment
        run: |
          echo "ğŸ‰ SafeWork Pro ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“ Registry: registry.jclee.me/safework:latest"  
          echo "ğŸ”— Public URL: https://safework.jclee.me"
          echo "ğŸ  Local URL: http://192.168.50.215:3001"
          echo "ğŸ¥ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ë¨"
          echo "ğŸ“¦ Repository: JCLEE94/safework"
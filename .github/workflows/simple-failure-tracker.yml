name: Simple CI/CD Failure Tracker

on:
  workflow_run:
    workflows: ["*"]
    types:
      - completed

permissions:
  issues: write

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const issueTitle = `[CI/CD Failure] ${workflow.name} - ${workflow.head_branch}`;
            
            // Check for existing issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(workflow.name) && 
              issue.title.includes(workflow.head_branch)
            );
            
            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ Another failure occurred\n\n**Time:** ${new Date().toISOString()}\n**Run:** ${workflow.html_url}\n**Commit:** ${workflow.head_sha.substring(0, 7)}`
              });
              console.log(`Added comment to existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## ğŸš¨ CI/CD Pipeline Failure\n\n**Workflow:** ${workflow.name}\n**Branch:** \`${workflow.head_branch}\`\n**Commit:** \`${workflow.head_sha.substring(0, 7)}\`\n**Failed at:** ${workflow.created_at}\n**Actor:** @${workflow.actor.login}\n\n### ğŸ“‹ Details\n\n[View workflow run](${workflow.html_url})\n\n### ğŸ·ï¸ Labels\n- ci-failure\n- automated\n\n---\n*This issue was automatically created by CI/CD Failure Tracker*`,
                labels: ['ci-failure', 'automated'],
                assignees: [workflow.actor.login]
              });
              console.log(`Created issue #${issue.data.number}`);
            }
name: Main CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_URL: registry.jclee.me
  IMAGE_NAME: safework

jobs:
  build:
    name: Build and Push
    runs-on: [self-hosted, linux]
    outputs:
      status: ${{ job.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build and push Docker image
        run: |
          # Login to registry
          echo "bingogo1" | docker login ${{ env.REGISTRY_URL }} -u "qws9411" --password-stdin
          
          # Build image
          docker build -f deployment/Dockerfile.prod -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest .
          
          # Push image
          docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          
          echo "✅ Image pushed successfully!"
      
      - name: Report build status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Build completed successfully"
          else
            echo "❌ Build failed - Issue will be created automatically"
          fi
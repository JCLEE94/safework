name: Main CI/CD Pipeline (Improved)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_URL: registry.jclee.me
  IMAGE_NAME: safework
  DOCKER_BUILDKIT: 1

jobs:
  test:
    name: Test Suite
    runs-on: [self-hosted, linux]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: health_management
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Run Backend Tests (STRICT)
        env:
          DATABASE_URL: postgresql://admin:password@localhost:5432/health_management
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          PYTHONPATH: ${{ github.workspace }}
        timeout-minutes: 10
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          
          echo "ðŸ§ª Running backend tests with strict failure handling..."
          pytest tests/ -v --cov=src --cov-report=term --cov-fail-under=70 --timeout=300 -x
          
          if [ $? -ne 0 ]; then
            echo "âŒ Backend tests failed - stopping deployment pipeline"
            exit 1
          fi
          echo "âœ… All backend tests passed"
      
      - name: Claude Max Code Review
        uses: grll/claude-code-base-action@beta
        continue-on-error: true
        with:
          prompt: |
            ðŸ¤– SafeWork Pro ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ ì½”ë“œ ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
            
            ## ðŸŽ¯ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:
            - **ë„ë©”ì¸**: ê±´ì„¤ì—… ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ
            - **ê¸°ìˆ ìŠ¤íƒ**: FastAPI (Python) + React (TypeScript) + PostgreSQL + Redis
            - **ì»´í”Œë¼ì´ì–¸ìŠ¤**: í•œêµ­ ì‚°ì—…ì•ˆì „ë³´ê±´ë²• ì¤€ìˆ˜ í•„ìš”
            - **ë°ì´í„°**: ê·¼ë¡œìž ê±´ê°•ì •ë³´, MSDS, ì‚¬ê³ ë³´ê³ , ê±´ê°•ê²€ì§„ ê²°ê³¼
            
            ## ðŸ” ì£¼ìš” ê²€í†  ê¸°ì¤€:
            1. **ë³´ì•ˆ ê²€í† ** (ìµœìš°ì„ ):
               - SQL Injection, XSS, CSRF ì·¨ì•½ì 
               - ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜ (ê·¼ë¡œìž ê±´ê°•ì •ë³´)
               - JWT í† í° ë° ì¸ì¦/ì¸ê°€ êµ¬ì¡°
               - ë¯¼ê°ì •ë³´ ë¡œê¹… ë° ë…¸ì¶œ ë°©ì§€
            
            2. **ì„±ëŠ¥ ìµœì í™”**:
               - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
               - Redis ìºì‹± ì „ëžµ
               - API ì‘ë‹µì‹œê°„ ê°œì„ 
               - ë¶ˆí•„ìš”í•œ N+1 ì¿¼ë¦¬ ì œê±°
            
            3. **ì½”ë“œ í’ˆì§ˆ**:
               - FastAPI ë² ìŠ¤íŠ¸ í”„ëž™í‹°ìŠ¤
               - React ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°
               - íƒ€ìž… ì•ˆì „ì„± (TypeScript)
               - ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…
            
            4. **ë„ë©”ì¸ íŠ¹í™” ê²€í† **:
               - ê±´ê°•ê²€ì§„ ë°ì´í„° ë¬´ê²°ì„±
               - MSDS í™”í•™ë¬¼ì§ˆ ê´€ë¦¬ ì •í™•ì„±
               - ì‚¬ê³ ë³´ê³  í”„ë¡œì„¸ìŠ¤ ì¤€ìˆ˜
               - ê·¼ë¡œìž ê°œì¸ì •ë³´ ë³´í˜¸
            
            ## ðŸ“‹ ê²€í†  ê²°ê³¼ í˜•ì‹:
            
            ### âœ… ìž˜ êµ¬í˜„ëœ ë¶€ë¶„
            - êµ¬ì²´ì ì¸ ì¢‹ì€ ì ë“¤...
            
            ### âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„
            - ìš°ì„ ìˆœìœ„ë³„ ì´ìŠˆ (High/Medium/Low)
            - êµ¬ì²´ì ì¸ ìˆ˜ì • ë°©ì•ˆ ì œì‹œ
            
            ### ðŸš€ ì¶”ê°€ ì œì•ˆì‚¬í•­
            - ì„±ëŠ¥ í–¥ìƒ ì•„ì´ë””ì–´
            - ë³´ì•ˆ ê°•í™” ë°©ì•ˆ
            - ì½”ë“œ êµ¬ì¡° ê°œì„ 
            
            **ìµœê·¼ ë³€ê²½ì‚¬í•­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„í•˜ë˜, ì „ì²´ ì½”ë“œë² ì´ìŠ¤ì˜ ì¼ê´€ì„±ë„ í•¨ê»˜ ê²€í† í•´ì£¼ì„¸ìš”.**
            **í•œêµ­ì–´ë¡œ ìƒì„¸í•˜ê³  ì‹¤í–‰ê°€ëŠ¥í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.**
          
          use_oauth: "true"
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          model: "claude-3-haiku-20240307"
          allowed_tools: "mcp__github__add_issue_comment,mcp__github__create_issue"
      
      - name: Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  build:
    name: Build and Push
    needs: test
    runs-on: [self-hosted, linux]
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate metadata
        id: meta
        run: |
          TAG="prod-$(date +%Y%m%d)-${GITHUB_SHA:0:7}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
      
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Build and push with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: |
            type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
            type=gha,scope=safework
          cache-to: |
            type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
            type=gha,mode=max,scope=safework
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}

  notify:
    name: Deployment Notification
    needs: build
    runs-on: [self-hosted, linux]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.build.result == 'success'
        run: |
          echo "âœ… Image pushed successfully: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}"
          echo "ðŸ¤– ArgoCD Image Updater will automatically deploy the new image"
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = `[CI/CD Failure] Main CI/CD Pipeline - ${context.ref.replace('refs/heads/', '')}`;
            
            // Check for existing open issues with same title
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bug'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (!existingIssue) {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## ðŸš¨ CI/CD Pipeline Failure\n\n**Workflow:** Main CI/CD Pipeline\n**Branch:** ${context.ref.replace('refs/heads/', '')}\n**Commit:** ${context.sha.substring(0, 7)}\n**Time:** ${new Date().toISOString()}\n**Actor:** @${context.actor}\n\n### ðŸ“‹ Details\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### ðŸ”§ Common Solutions\n\n1. Check Docker build logs\n2. Verify registry credentials\n3. Check Dockerfile syntax\n4. Ensure all dependencies are available\n\n---\n*Automatically created by CI/CD failure tracking*`,
                labels: ['bug', 'ci/cd']
              });
              console.log(`Created issue #${issue.data.number}`);
            } else {
              console.log(`Issue already exists: #${existingIssue.number}`);
            }
name: SafeWork Pro - K8s Deploy

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework
  K8S_SERVER: 192.168.50.110
  K8S_NAMESPACE: safework

jobs:
  build:
    runs-on: self-hosted
    
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build SafeWork Pro Image
        id: build
        run: |
          # ë¹Œë“œ ì‹œê°„ ì„¤ì •
          BUILD_TIME=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')
          IMAGE_TAG=${{ github.sha }}
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -f deployment/Dockerfile.prod -t ${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            .
          
          # latest íƒœê·¸ë„ ì¶”ê°€
          docker tag ${{ env.IMAGE_NAME }}:${IMAGE_TAG} ${{ env.IMAGE_NAME }}:latest
          
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        
      - name: Login to Private Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          
      - name: Push to Registry
        run: |
          IMAGE_TAG=${{ steps.build.outputs.tag }}
          
          # ë ˆì§€ìŠ¤íŠ¸ë¦¬ìš© íƒœê·¸ ìƒì„±
          docker tag ${{ env.IMAGE_NAME }}:${IMAGE_TAG} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Test Container Health
        run: |
          # ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop safework-test || true
          docker rm safework-test || true
          
          # í…ŒìŠ¤íŠ¸ìš© ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d --name safework-test -p 3002:8000 \
            -e DISABLE_AUTH=true \
            -e DATABASE_URL=sqlite:///test.db \
            -e REDIS_URL=redis://localhost:6379/0 \
            ${{ env.IMAGE_NAME }}:latest
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸..."
          for i in {1..5}; do
            if curl -f http://localhost:3002/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5), 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            fi
          done
          
          # í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop safework-test
          docker rm safework-test

  deploy-k8s:
    needs: build
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        run: |
          # kubectl ì„¤ì¹˜ í™•ì¸
          if ! command -v kubectl &> /dev/null; then
            echo "kubectl ì„¤ì¹˜ ì¤‘..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          fi
          
          # kubeconfig ì„¤ì •
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # í´ëŸ¬ìŠ¤í„° ì—°ê²° í…ŒìŠ¤íŠ¸
          kubectl cluster-info
          kubectl get nodes
      
      - name: Update K8s Manifests
        run: |
          IMAGE_TAG=${{ needs.build.outputs.image-tag }}
          
          # ë°±ì—”ë“œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s|registry.jclee.me/safework:latest|registry.jclee.me/safework:${IMAGE_TAG}|g" k8s/backend/backend-deployment.yaml
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©)
          sed -i "s|registry.jclee.me/safework:latest|registry.jclee.me/safework:${IMAGE_TAG}|g" k8s/frontend/frontend-deployment.yaml
          
          echo "âœ… K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG})"
      
      - name: Deploy to Kubernetes
        run: |
          echo "ğŸš€ SafeWork Pro K8s ë°°í¬ ì‹œì‘..."
          
          # Namespace ìƒì„±/ì—…ë°ì´íŠ¸
          kubectl apply -f k8s/namespace/namespace.yaml
          
          # ConfigMap ë° Secret ë°°í¬
          kubectl apply -f k8s/configmap/app-config.yaml
          kubectl apply -f k8s/secrets/app-secrets.yaml
          
          # ìŠ¤í† ë¦¬ì§€ ë°°í¬
          kubectl apply -f k8s/storage/persistent-volumes.yaml
          
          # ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
          kubectl apply -f k8s/postgres/postgres-simple.yaml
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          
          # Redis ë°°í¬
          kubectl apply -f k8s/redis/redis-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=redis -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          
          # ë°±ì—”ë“œ ë°°í¬
          kubectl apply -f k8s/backend/backend-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=safework,component=backend -n ${{ env.K8S_NAMESPACE }} --timeout=600s
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
          kubectl apply -f k8s/frontend/frontend-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=safework,component=frontend -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          
          # Ingress ë°°í¬
          kubectl apply -f k8s/ingress/ingress.yaml
          
          echo "âœ… K8s ë°°í¬ ì™„ë£Œ!"
      
      - name: Verify Deployment
        run: |
          echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # Pod ìƒíƒœ í™•ì¸
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          
          # Service ìƒíƒœ í™•ì¸
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
          
          # Ingress ìƒíƒœ í™•ì¸
          kubectl get ingress -n ${{ env.K8S_NAMESPACE }}
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬..."
          for i in {1..10}; do
            if kubectl exec -n ${{ env.K8S_NAMESPACE }} deployment/safework-backend -- curl -f http://localhost:8000/health; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/10), 10ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 10
            fi
          done
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
          echo "ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬..."
          for i in {1..5}; do
            if kubectl exec -n ${{ env.K8S_NAMESPACE }} deployment/safework-frontend -- curl -f http://localhost:80/nginx-health; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5), 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            fi
          done
      
      - name: Get Service URLs
        run: |
          echo "ğŸ“ SafeWork Pro ì„œë¹„ìŠ¤ ì •ë³´:"
          
          # NodePort ë˜ëŠ” LoadBalancer IP í™•ì¸
          FRONTEND_PORT=$(kubectl get svc frontend-service -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
          BACKEND_PORT=$(kubectl get svc backend-service -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
          
          echo "ğŸŒ Frontend: http://${{ env.K8S_SERVER }}:${FRONTEND_PORT}"
          echo "âš¡ Backend: http://${{ env.K8S_SERVER }}:${BACKEND_PORT}"
          echo "ğŸ”— Domain: https://safework.jclee.me"
          echo "ğŸ“¦ Image: registry.jclee.me/safework:${{ needs.build.outputs.image-tag }}"
      
      - name: Notify Deployment Success
        run: |
          echo "ğŸ‰ SafeWork Pro K8s ë°°í¬ ì„±ê³µ!"
          echo "ğŸ“ í´ëŸ¬ìŠ¤í„°: ${{ env.K8S_SERVER }}"
          echo "ğŸ“‚ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${{ env.K8S_NAMESPACE }}"
          echo "ğŸ¥ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œì´ Kubernetesë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"

  rollback:
    needs: [build, deploy-k8s]
    runs-on: self-hosted
    if: failure()
    
    steps:
      - name: Rollback on Failure
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨, ë¡¤ë°± ìˆ˜í–‰ ì¤‘..."
          
          # kubectl ì„¤ì •
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          
          # ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
          kubectl rollout undo deployment/safework-backend -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/safework-frontend -n ${{ env.K8S_NAMESPACE }}
          
          # ë¡¤ë°± ìƒíƒœ í™•ì¸
          kubectl rollout status deployment/safework-backend -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout status deployment/safework-frontend -n ${{ env.K8S_NAMESPACE }}
          
          echo "ğŸ”„ ë¡¤ë°± ì™„ë£Œ"
name: GitOps CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework
  CHART_NAME: safework
  NAMESPACE: safework

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Test simple step
        run: |
          echo "ğŸš€ GitOps íŒŒì´í”„ë¼ì¸ ì‹œì‘"
          echo "ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'
          
      - name: Package Helm chart
        run: |
          echo "ğŸ“¦ Helm Chart íŒ¨í‚¤ì§• ì‹œì‘"
          
          # Chart ë²„ì „ ì„¤ì •
          COMMIT_SHA="${{ github.sha }}"
          CHART_VERSION="1.0.0-${COMMIT_SHA:0:7}"
          
          echo "Chart Version: ${CHART_VERSION}"
          
          # Chart íŒ¨í‚¤ì§•
          helm package ./charts/${{ env.CHART_NAME }} --destination ./
          
          echo "âœ… Helm Chart íŒ¨í‚¤ì§• ì™„ë£Œ"
          ls -la *.tgz
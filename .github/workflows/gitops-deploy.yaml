name: GitOps CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework
  CHART_NAME: safework
  NAMESPACE: safework

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Test simple step
        run: |
          echo "🚀 GitOps 파이프라인 시작"
          echo "브랜치: ${{ github.ref }}"
          echo "커밋: ${{ github.sha }}"
          
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'
          
      - name: Package Helm chart
        run: |
          echo "📦 Helm Chart 패키징 시작"
          
          # Chart 버전 설정
          COMMIT_SHA="${{ github.sha }}"
          CHART_VERSION="1.0.0-${COMMIT_SHA:0:7}"
          
          echo "Chart Version: ${CHART_VERSION}"
          
          # Chart 패키징
          helm package ./charts/${{ env.CHART_NAME }} --destination ./
          
          echo "✅ Helm Chart 패키징 완료"
          ls -la *.tgz
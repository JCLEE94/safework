name: GitOps CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework
  CHART_NAME: safework
  NAMESPACE: safework

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build and push Docker image
        run: |
          echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
          
          # ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
          COMMIT_SHA="${{ github.sha }}"
          IMAGE_TAG="${COMMIT_SHA:0:7}"
          
          echo "ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ì¸ì¦ ì—†ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬)
          docker build -t ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
          docker tag ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
          
          # ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${REGISTRY}/${IMAGE_NAME}:latest
          
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
          
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'
          
      - name: Package and upload Helm chart
        run: |
          echo "ğŸ“¦ Helm Chart íŒ¨í‚¤ì§• ì‹œì‘"
          
          # Chart ë²„ì „ ì„¤ì •
          COMMIT_SHA="${{ github.sha }}"
          CHART_VERSION="1.0.0-${COMMIT_SHA:0:7}"
          
          echo "Chart Version: ${CHART_VERSION}"
          
          # Chart.yaml ë²„ì „ ì—…ë°ì´íŠ¸
          sed -i "s/^version:.*/version: ${CHART_VERSION}/" ./charts/${CHART_NAME}/Chart.yaml
          
          # Chart íŒ¨í‚¤ì§•
          helm package ./charts/${CHART_NAME} --destination ./
          
          # ChartMuseumì— ì—…ë¡œë“œ
          echo "ğŸ“¤ ChartMuseumì— Chart ì—…ë¡œë“œ ì¤‘..."
          curl -u admin:bingogo1 --data-binary "@${CHART_NAME}-${CHART_VERSION}.tgz" \
            https://charts.jclee.me/api/charts
          
          echo "âœ… Helm Chart íŒ¨í‚¤ì§• ë° ì—…ë¡œë“œ ì™„ë£Œ"
          
      - name: Trigger ArgoCD sync
        run: |
          echo "ğŸ”„ ArgoCD ë™ê¸°í™” íŠ¸ë¦¬ê±°"
          
          # ArgoCD CLI ì„¤ì¹˜
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          
          # ArgoCD ë¡œê·¸ì¸ ë° ë™ê¸°í™”
          argocd login argo.jclee.me --username admin --password bingogo1 --insecure --grpc-web
          argocd app sync safework --grpc-web
          
          echo "âœ… ArgoCD ë™ê¸°í™” ì™„ë£Œ"
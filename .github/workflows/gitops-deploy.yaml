name: GitOps CI/CD Pipeline

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    
env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: safework
  CHART_NAME: safework
  NAMESPACE: safework
  
jobs:
  test:
    runs-on: self-hosted
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Run tests
        run: |
          pytest tests/ -v --timeout=60 -x

  build-and-deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Registry
        run: |
          echo "ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ (ê³µê°œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ì¸ì¦ ìƒëµ)"
          
      - name: Extract metadata
        id: meta
        run: |
          COMMIT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BUILD_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          
          # íƒœê·¸ ìƒì„±
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="latest"
          fi
          
          PROD_TAG="prod-$(date +%Y%m%d)-${COMMIT_SHA:0:7}"
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_OUTPUT
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${PROD_TAG}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "prod_tag=${PROD_TAG}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
      - name: Build and push Docker image
        run: |
          # All-in-one ì´ë¯¸ì§€ ë¹Œë“œ
          docker build \
            -f deployment/Dockerfile.allinone \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.prod_tag }} \
            --build-arg BUILD_TIME="${{ steps.meta.outputs.build_date }}" \
            .
          
          # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ (ê³µê°œ ë ˆì§€ìŠ¤íŠ¸ë¦¬)
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.prod_tag }}
          
          echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          echo "- íƒœê·¸: ${{ steps.meta.outputs.version }}"
          echo "- í”„ë¡œë•ì…˜ íƒœê·¸: ${{ steps.meta.outputs.prod_tag }}"
          
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'
          
      - name: Package and deploy Helm chart
        env:
          CHARTMUSEUM_URL: https://charts.jclee.me
          CHARTMUSEUM_USERNAME: admin
          CHARTMUSEUM_PASSWORD: bingogo1
        run: |
          set -euo pipefail
          
          # ë²„ì „ ì •ë³´ ì„¤ì •
          COMMIT_SHA="${{ github.sha }}"
          CHART_VERSION="1.0.0-${COMMIT_SHA:0:7}"
          IMAGE_TAG="${{ steps.meta.outputs.prod_tag }}"
          
          echo "ğŸ“¦ Helm Chart íŒ¨í‚¤ì§• ì‹œì‘"
          echo "Chart Version: ${CHART_VERSION}"
          echo "Image Tag: ${IMAGE_TAG}"
          
          # Chart ë²„ì „ê³¼ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s/^version:.*/version: ${CHART_VERSION}/" ./charts/${{ env.CHART_NAME }}/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${IMAGE_TAG}\"/" ./charts/${{ env.CHART_NAME }}/Chart.yaml
          sed -i "s/tag:.*/tag: \"${IMAGE_TAG}\"/" ./charts/${{ env.CHART_NAME }}/values.yaml
          
          # Helm ì°¨íŠ¸ íŒ¨í‚¤ì§•
          helm package ./charts/${{ env.CHART_NAME }} --destination ./
          
          # ChartMuseumì— ì—…ë¡œë“œ
          CHART_FILE="${{ env.CHART_NAME }}-${CHART_VERSION}.tgz"
          
          echo "ğŸ“¤ ${CHART_FILE}ë¥¼ ChartMuseumì— ì—…ë¡œë“œ ì¤‘..."
          
          HTTP_CODE=$(curl -w "%{http_code}" -s -o /tmp/upload_response.txt \
            -u ${CHARTMUSEUM_USERNAME}:${CHARTMUSEUM_PASSWORD} \
            --data-binary "@${CHART_FILE}" \
            ${CHARTMUSEUM_URL}/api/charts)
          
          echo "HTTP Response Code: ${HTTP_CODE}"
          echo "Response Body:"
          cat /tmp/upload_response.txt
          
          if [ "${HTTP_CODE}" = "201" ] || [ "${HTTP_CODE}" = "409" ]; then
            echo "âœ… Chart ì—…ë¡œë“œ ì„±ê³µ: ${CHART_VERSION}"
          else
            echo "âŒ Chart ì—…ë¡œë“œ ì‹¤íŒ¨ (HTTP ${HTTP_CODE})"
            exit 1
          fi
          
          # ì—…ë¡œë“œëœ ì°¨íŠ¸ í™•ì¸
          echo "ğŸ” Chart ì—…ë¡œë“œ ê²€ì¦ ì¤‘..."
          curl -s -u ${CHARTMUSEUM_USERNAME}:${CHARTMUSEUM_PASSWORD} \
            ${CHARTMUSEUM_URL}/api/charts/${{ env.CHART_NAME }} | \
            grep -q "${CHART_VERSION}" && echo "âœ… Chart ê²€ì¦ ì™„ë£Œ" || echo "âš  Chart ê²€ì¦ ì‹¤íŒ¨"
            
      - name: Update ArgoCD Application
        env:
          ARGOCD_URL: argo.jclee.me
          ARGOCD_USERNAME: admin
          ARGOCD_PASSWORD: bingogo1
        run: |
          set -euo pipefail
          
          # ArgoCD CLI ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ê±´ë„ˆëœ€)
          if ! command -v argocd &> /dev/null; then
            echo "ğŸ“¥ ArgoCD CLI ì„¤ì¹˜ ì¤‘..."
            curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
            rm argocd-linux-amd64
          fi
          
          # ArgoCD ë¡œê·¸ì¸
          echo "ğŸ” ArgoCD ë¡œê·¸ì¸ ì¤‘..."
          argocd login ${ARGOCD_URL} \
            --username ${ARGOCD_USERNAME} \
            --password ${ARGOCD_PASSWORD} \
            --insecure --grpc-web
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™”
          echo "ğŸ”„ ArgoCD ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™” ì¤‘..."
          if argocd app get safework-gitops --grpc-web > /dev/null 2>&1; then
            argocd app sync safework-gitops --grpc-web
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âš  ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”."
          fi
            
      - name: Deployment notification
        if: success()
        run: |
          echo "ğŸš€ SafeWork Pro ë°°í¬ ì™„ë£Œ!"
          echo "- ì´ë¯¸ì§€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.prod_tag }}"
          echo "- Chart ë²„ì „: 1.0.0-${{ github.sha:0:7 }}"
          echo "- ì ‘ì† URL: https://safework.jclee.me"
          echo "- NodePort: 32301"
          
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "âŒ SafeWork Pro ë°°í¬ ì‹¤íŒ¨!"
          echo "- ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
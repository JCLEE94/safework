# SafeWork Pro - Optimized Deploy Pipeline (ArgoCD Image Updater)
# ArgoCD Image Updaterë¥¼ í™œìš©í•œ ìµœì í™”ëœ ë°°í¬ íŒŒì´í”„ë¼ì¸

name: Deploy Optimized

on:
  push:
    branches: [main, develop]
    tags: ['v*']

env:
  REGISTRY: ${{ vars.REGISTRY_URL }}
  IMAGE_NAME: ${{ vars.ORG }}/${{ vars.APP_NAME }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ì½”ë“œ í’ˆì§ˆ í™•ì¸ (ìµœì†Œí•œ)
  validate:
    name: Basic Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check repository structure
        run: |
          echo "ðŸ“ Checking project structure..."
          ls -la
          [ -f "src/app.py" ] && echo "âœ… Backend found" || echo "âŒ Backend missing"
          [ -d "frontend" ] && echo "âœ… Frontend found" || echo "âŒ Frontend missing"
          [ -f "deployment/Dockerfile" ] && echo "âœ… Dockerfile found" || echo "âŒ Dockerfile missing"
          echo "âœ… Structure validation complete"

  # Docker ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create frontend build (minimal)
        run: |
          mkdir -p frontend/dist
          cat > frontend/dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>SafeWork Pro - ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  h1 { color: #2563eb; }
                  .status { background: #10b981; color: white; padding: 10px; border-radius: 5px; }
              </style>
          </head>
          <body>
              <h1>SafeWork Pro</h1>
              <p>ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
              <div class="status">
                  System is operational - Build: ${{ github.run_number }}
              </div>
              <p>Commit: <code>${{ github.sha }}</code></p>
          </body>
          </html>
          EOF
          echo "âœ… Frontend build created"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry  
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Generate metadata
        id: meta
        run: |
          DATE=$(date +%Y%m%d)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # ArgoCD Image Updater í˜¸í™˜ íƒœê·¸ íŒ¨í„´
          PROD_TAG="prod-${DATE}-${SHORT_SHA}"
          SEMANTIC_TAG="1.${DATE}.${{ github.run_number }}"
          
          echo "prod_tag=${PROD_TAG}" >> $GITHUB_OUTPUT
          echo "semantic_tag=${SEMANTIC_TAG}" >> $GITHUB_OUTPUT
          
          echo "### ðŸ·ï¸ Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "- **Production**: \`${PROD_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic**: \`${SEMANTIC_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.prod_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.semantic_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Deployment status
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.prod_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.semantic_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Image Updater" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD Image Updater will automatically detect and deploy the new image." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor deployment:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ [ArgoCD Dashboard](${{ vars.ARGOCD_URL }}/applications/${{ vars.APP_NAME }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ [Production URL](https://${{ vars.APP_NAME }}.jclee.me)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Registry](${{ env.REGISTRY }})" >> $GITHUB_STEP_SUMMARY

  # ìƒíƒœ ìš”ì•½
  status:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: Pipeline summary
        run: |
          echo "## ðŸ“Š SafeWork Pro CI/CD Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "âœ… **Validation**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Validation**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… **Build & Push**: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ArgoCD Image Updaterê°€ ìƒˆ ì´ë¯¸ì§€ë¥¼ ìžë™ ê°ì§€í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            echo "2. K8s ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ê°€ ìžë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            echo "3. ìƒˆ ë²„ì „ì´ í”„ë¡œë•ì…˜ì— ë°°í¬ë©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "skipped" ]]; then
            echo "â­ï¸ **Build & Push**: SKIPPED (PR)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build & Push**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
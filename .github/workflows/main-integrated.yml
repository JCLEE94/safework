name: SafeWork Pro - Integrated Pipeline with Claude

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        type: boolean
        default: false
      skip_claude:
        description: 'Skip Claude review'
        required: false
        type: boolean
        default: false

env:
  REGISTRY_URL: registry.jclee.me
  IMAGE_NAME: safework
  DOCKER_BUILDKIT: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== 0ë‹¨ê³„: ì¤‘ë³µ ì‹¤í–‰ ì·¨ì†Œ =====
  cancel-previous:
    name: Cancel Previous Runs
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
          workflow_id: ${{ github.workflow }}
          ignore_sha: true
          all_but_latest: true

  # ===== 1ë‹¨ê³„: Claude AI ì½”ë“œ ë¶„ì„ =====
  claude-analysis:
    name: Claude AI Analysis
    runs-on: ubuntu-latest
    needs: [cancel-previous]
    if: ${{ !inputs.skip_claude }}
    outputs:
      review-status: ${{ steps.analysis.outputs.status }}
      critical-issues: ${{ steps.analysis.outputs.critical }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Load MCP Configuration
        id: mcp
        run: |
          if [ -f ".mcp.json" ]; then
            echo "ğŸ” MCP configuration found"
            MCP_CONFIG=$(cat .mcp.json | jq -c .)
            echo "config<<EOF" >> $GITHUB_OUTPUT
            echo "$MCP_CONFIG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "config={}" >> $GITHUB_OUTPUT
          fi
      
      - name: Prepare Claude Prompt
        id: prompt
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          # PRì¸ ê²½ìš° diff ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            DIFF=$(gh pr diff ${{ github.event.pull_request.number }} || echo "")
          else
            DIFF=$(git diff HEAD~1 HEAD || echo "")
          fi
          
          # í”„ë¡¬í”„íŠ¸ ìƒì„±
          cat > claude-prompt.txt <<EOF
          You are reviewing SafeWork Pro, a Korean construction site health management system.
          
          ğŸ¯ SYSTEMATIC MCP-POWERED ANALYSIS WORKFLOW:
          
          **STEP 1: Context Gathering with MCP Tools**
          1. Use mcp__github__search_issues with "security" to find similar security issues
          2. Use mcp__github__search_pull_requests with "fix" to see previous fixes
          3. Use mcp__memory__search_nodes with "safework review" to recall patterns
          4. Use mcp__brave-search__brave_web_search for "Korean medical data protection law 2024"
          5. Use mcp__sequential-thinking__sequentialthinking to plan analysis strategy
          
          **STEP 2: Code Pattern Analysis**
          1. Use mcp__github__get_file_contents on each changed file
          2. Use mcp__memory__create_entities for each critical finding
          3. Use mcp__sequential-thinking for complex security analysis
          4. Use mcp__brave-search for Korean compliance verification:
             - "ì˜ë£Œë²• ê°œì¸ì •ë³´ë³´í˜¸ requirements 2024"
             - "Korean healthcare data encryption standards"
             - "ê°œì¸ì •ë³´ë³´í˜¸ë²• medical records compliance"
          
          **STEP 3: Knowledge Graph Building**
          1. Create entities for each code vulnerability found
          2. Create relations between vulnerabilities and compliance issues
          3. Add observations about fix recommendations
          4. Build memory for future reviews
          
          **STEP 4: Comprehensive Security Review**
          Focus on:
          - SQL injection patterns in database queries
          - XSS vulnerabilities in web endpoints
          - Authentication/authorization flaws
          - Korean medical data handling compliance (ì˜ë£Œë²•)
          - Personal information protection (ê°œì¸ì •ë³´ë³´í˜¸ë²•)
          - HTTPS/TLS configuration
          - Input validation on medical data
          - Audit logging for patient data access
          
          **STEP 5: Generate Structured Report**
          Use findings to create:
          - Critical issues that block deployment
          - Warning issues for future improvement
          - Info recommendations for best practices
          - Korean law compliance status
          
          ğŸ”§ CHANGED FILES TO ANALYZE:
          $CHANGED_FILES
          
          ğŸ“‹ RECENT CHANGES:
          \`\`\`diff
          $(echo "$DIFF" | head -n 500)
          \`\`\`
          
          ğŸš€ START NOW:
          1. Search GitHub for similar security issues in medical systems
          2. Check memory for previous SafeWork review patterns
          3. Search Korean healthcare regulations
          4. Analyze each file systematically using sequential thinking
          5. Build knowledge graph of findings
          6. Generate final security assessment
          
          âš ï¸ CRITICAL: Use ALL MCP tools extensively. This is a medical system handling sensitive Korean patient data.
          EOF
          
          PROMPT=$(cat claude-prompt.txt)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Run Claude Analysis
        id: analysis
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: ${{ steps.prompt.outputs.prompt }}
          mcp_config: ${{ steps.mcp.outputs.config }}
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,mcp__github__*,mcp__memory__*,mcp__sequential-thinking__*,mcp__brave-search__*"
          max_turns: 5
          timeout_minutes: 8
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: security_review
        continue-on-error: true
      
      - name: Parse Claude Results
        id: parse
        if: always()
        run: |
          echo "ğŸ” Claude Analysis Results:"
          echo "Outcome: ${{ steps.analysis.outcome }}"
          
          # Claude actionì˜ ì‹¤ì œ ì¶œë ¥ í™•ì¸
          if [ "${{ steps.analysis.outcome }}" == "success" ]; then
            echo "status=reviewed" >> $GITHUB_OUTPUT
            
            # Claude ì¶œë ¥ì—ì„œ critical issues ì¶”ì¶œ ì‹œë„
            CLAUDE_OUTPUT="${{ steps.analysis.outputs.result || '' }}"
            echo "Claude Output: $CLAUDE_OUTPUT"
            
            # Critical/Error/CRITICAL í‚¤ì›Œë“œë¡œ ì¤‘ìš” ì´ìŠˆ ì¹´ìš´íŠ¸
            CRITICAL_COUNT=$(echo "$CLAUDE_OUTPUT" | grep -i -c "critical\|error\|security.*issue\|must.*fix" || echo "0")
            echo "Found $CRITICAL_COUNT critical issues"
            echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            
            # ì¶”ì²œ ê²°ê³¼ ì¶”ì¶œ
            if echo "$CLAUDE_OUTPUT" | grep -i "reject\|needs.*fix\|critical.*issue" > /dev/null; then
              RECOMMENDATION="needs-fixes"
            elif echo "$CLAUDE_OUTPUT" | grep -i "approve\|looks.*good\|no.*issue" > /dev/null; then
              RECOMMENDATION="approved"
            else
              RECOMMENDATION="reviewed"
            fi
            echo "recommendation=$RECOMMENDATION" >> $GITHUB_OUTPUT
            
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "recommendation=skipped" >> $GITHUB_OUTPUT
          fi
          
          # ìƒì„¸í•œ ê²°ê³¼ ìš”ì•½
          echo "## ğŸ¤– Claude AI Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.analysis.outcome }}" == "success" ]; then
            echo "âœ… **Code review completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Analysis Result:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.analysis.outputs.result || 'No detailed output available' }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Key Findings:**" >> $GITHUB_STEP_SUMMARY
            echo "- Critical Issues: $CRITICAL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- Recommendation: $RECOMMENDATION" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Code review skipped or failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.analysis.outputs.error || 'Unknown error' }}" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create Issues for Critical Findings
        if: steps.parse.outputs.critical != '0' && steps.parse.outputs.status == 'reviewed'
        uses: actions/github-script@v7
        with:
          script: |
            const claudeOutput = `${{ steps.analysis.outputs.result || '' }}`;
            const criticalCount = ${{ steps.parse.outputs.critical || 0 }};
            const recommendation = `${{ steps.parse.outputs.recommendation }}`;
            
            if (criticalCount > 0) {
              const issueTitle = `ğŸ¤– Claude AIê°€ ë°œê²¬í•œ ì¤‘ìš” ì½”ë“œ ì´ìŠˆ (${criticalCount}ê°œ)`;
              const issueBody = `## ğŸš¨ Claude AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼
              
**ì»¤ë°‹**: ${context.sha.substring(0, 7)}
**ë¸Œëœì¹˜**: ${context.ref}
**ë¶„ì„ ì‹œê°„**: ${new Date().toISOString()}
**ì¶”ì²œì‚¬í•­**: ${recommendation}

## ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼

\`\`\`
${claudeOutput}
\`\`\`

## ğŸ”§ í•´ê²° ë°©ë²•

1. ìœ„ì—ì„œ ì§€ì ëœ critical ì´ìŠˆë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ìˆ˜ì •
2. ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆëŠ” ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”
3. í•œêµ­ ì˜ë£Œë²•/ê°œì¸ì •ë³´ë³´í˜¸ë²• ê´€ë ¨ ì´ìŠˆëŠ” ë²•ì  ê²€í†  í•„ìš”

## ğŸ“Š í†µê³„
- **Critical Issues**: ${criticalCount}ê°œ
- **MCP ë„êµ¬ í™œìš©**: GitHub, Memory, Sequential-thinking, Brave-search

---
*ì´ ì´ìŠˆëŠ” Claude AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.*
*ì›Œí¬í”Œë¡œìš°: [${context.workflow}](${context.server_url}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['claude-ai', 'code-review', 'priority:high', 'security']
              });
              
              console.log(`âœ… Created issue for ${criticalCount} critical findings`);
            }
      
      - name: Add PR Review Comment
        if: github.event_name == 'pull_request' && steps.parse.outputs.status == 'reviewed'
        uses: actions/github-script@v7
        with:
          script: |
            const claudeOutput = `${{ steps.analysis.outputs.result || '' }}`;
            const criticalCount = ${{ steps.parse.outputs.critical || 0 }};
            const recommendation = `${{ steps.parse.outputs.recommendation }}`;
            
            let reviewComment = `## ğŸ¤– Claude AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n`;
            
            if (criticalCount > 0) {
              reviewComment += `âš ï¸ **${criticalCount}ê°œì˜ ì¤‘ìš” ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!**\n\n`;
              reviewComment += `**ì¶”ì²œì‚¬í•­**: ${recommendation}\n\n`;
              reviewComment += `### ğŸ“‹ ìƒì„¸ ë¶„ì„\n\`\`\`\n${claudeOutput}\n\`\`\`\n\n`;
              reviewComment += `### ğŸš¨ ì¡°ì¹˜ í•„ìš”\n`;
              reviewComment += `- Critical ì´ìŠˆë“¤ì„ ìˆ˜ì • í›„ ì¬ê²€í†  ìš”ì²­\n`;
              reviewComment += `- ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆëŠ” ìš°ì„  ì²˜ë¦¬ í•„ìš”\n`;
            } else {
              reviewComment += `âœ… **ì½”ë“œ ë¦¬ë·° ì™„ë£Œ - ì¤‘ìš” ì´ìŠˆ ì—†ìŒ**\n\n`;
              reviewComment += `**ì¶”ì²œì‚¬í•­**: ${recommendation}\n\n`;
              reviewComment += `### ğŸ“‹ ë¶„ì„ ê²°ê³¼\n\`\`\`\n${claudeOutput}\n\`\`\`\n`;
            }
            
            reviewComment += `\n---\n*MCP ë„êµ¬ í™œìš©: GitHub, Memory, Sequential-thinking, Brave-search*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });

  # ===== ìë™ ìˆ˜ì • ë‹¨ê³„ =====
  auto-fix:
    name: Claude Auto-Fix Issues
    runs-on: ubuntu-latest
    needs: [claude-analysis]
    if: needs.claude-analysis.outputs.critical-issues != '0' && needs.claude-analysis.outputs.review-status == 'reviewed'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Claude Auto-Fix Bot"
      
      - name: Load MCP Configuration
        id: mcp
        run: |
          if [ -f ".mcp.json" ]; then
            MCP_CONFIG=$(cat .mcp.json | jq -c .)
            echo "config<<EOF" >> $GITHUB_OUTPUT
            echo "$MCP_CONFIG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "config={}" >> $GITHUB_OUTPUT
          fi
      
      - name: Prepare Auto-Fix Prompt
        id: fix-prompt
        run: |
          # ì´ì „ ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
          ANALYSIS_RESULT="${{ needs.claude-analysis.outputs.critical-issues }}"
          
          # ìˆ˜ì •ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±
          cat > claude-fix-prompt.txt <<EOF
          You are Claude Code Auto-Fix Bot for SafeWork Pro (ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œ).
          
          Previous analysis found critical issues that need to be fixed automatically.
          
          ğŸš€ STEP-BY-STEP SERENA MCP USAGE:
          
          1. **Activate Serena Project**:
             Use: mcp__serena__activate_project with "." (current directory)
             
          2. **Get Project Overview**:
             Use: mcp__serena__get_symbols_overview with "src/" to understand codebase structure
             
          3. **Find Security Issues**:
             Use: mcp__serena__search_for_pattern to find:
             - SQL injection patterns: "execute.*%s|format.*query"
             - XSS vulnerabilities: "innerHTML|dangerouslySetInnerHTML"
             - Hardcoded secrets: "password.*=|secret.*=|key.*="
             - Missing input validation: "request\\..*without.*validation"
             
          4. **Analyze Critical Files**:
             Use: mcp__serena__find_symbol to examine:
             - Authentication handlers: "auth|login|token"
             - Database operations: "query|execute|cursor"
             - API endpoints: "route|endpoint|handler"
             - Data validation: "validate|sanitize|clean"
             
          5. **Apply Automatic Fixes**:
             For each security issue found, use:
             - mcp__serena__replace_symbol_body: Fix function implementations
             - mcp__serena__insert_after_symbol: Add security validations
             - mcp__serena__replace_regex: Fix patterns across multiple files
             
          6. **Korean Compliance Fixes**:
             - Add personal data encryption for medical records
             - Implement data retention policies (ì˜ë£Œë²• ì¤€ìˆ˜)
             - Add audit logging for all data access
             - Ensure HTTPS and secure headers
          
          ğŸ¯ SPECIFIC FIXES TO APPLY:
          
          **Security Enhancements**:
          - Replace string formatting in SQL with parameterized queries
          - Add input validation decorators to all API endpoints
          - Implement rate limiting on authentication endpoints
          - Add CSRF tokens to all forms
          - Sanitize all user inputs before database storage
          
          **Korean Law Compliance**:
          - Add ê°œì¸ì •ë³´ë³´í˜¸ë²• compliant data handling
          - Implement medical data encryption (ì˜ë£Œë²• Article 21)
          - Add data access logging and audit trails
          - Ensure proper consent management
          
          **Error Handling**:
          - Add try-catch blocks around database operations
          - Implement proper logging without exposing sensitive data
          - Add graceful error responses for API endpoints
          
          ğŸ’¡ SERENA MCP TOOLS TO USE:
          - mcp__serena__activate_project: "."
          - mcp__serena__get_symbols_overview: "src/"
          - mcp__serena__find_symbol: Find specific functions/classes
          - mcp__serena__search_for_pattern: Find security patterns
          - mcp__serena__replace_symbol_body: Fix entire functions
          - mcp__serena__insert_before_symbol: Add imports/decorators
          - mcp__serena__insert_after_symbol: Add new security functions
          - mcp__serena__replace_regex: Fix patterns across files
          
          ğŸ”§ EXAMPLE SERENA WORKFLOW:
          1. activate_project(".")
          2. get_symbols_overview("src/")
          3. search_for_pattern("execute.*%s", restrict_search_to_code_files=true)
          4. find_symbol("login", relative_path="src/handlers/")
          5. replace_symbol_body("login", "src/handlers/auth.py", "secure_login_implementation")
          6. insert_after_symbol("login", "src/handlers/auth.py", "rate_limiting_decorator")
          
          âš ï¸ CRITICAL: Use Serena MCP tools extensively. Do NOT just analyze - actively modify code files using Serena's editing capabilities.
          
          Start NOW by activating Serena project and systematically fixing all security issues.
          EOF
          
          PROMPT=$(cat claude-fix-prompt.txt)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Run Claude Auto-Fix
        id: auto-fix
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: ${{ steps.fix-prompt.outputs.prompt }}
          mcp_config: ${{ steps.mcp.outputs.config }}
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,Write,mcp__serena__*,mcp__github__*,mcp__memory__*,mcp__sequential-thinking__*,mcp__brave-search__*"
          max_turns: 15
          timeout_minutes: 20
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: auto_fix
            SERENA_WORKSPACE: ${{ github.workspace }}
        continue-on-error: true
      
      - name: Check for Changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Claude made automatic fixes!"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No automatic fixes were applied"
          fi
      
      - name: Commit Auto-Fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "ğŸ¤– Claude Auto-Fix: ë³´ì•ˆ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ì´ìŠˆ ìë™ ìˆ˜ì •

          - Claude AIê°€ ë°œê²¬í•œ critical ì´ìŠˆë“¤ ìë™ ìˆ˜ì •
          - ë³´ì•ˆ ì·¨ì•½ì  íŒ¨ì¹˜ (SQL injection, XSS ë“±)
          - í•œêµ­ ì˜ë£Œë²•/ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜ ê°•í™”
          - ì…ë ¥ ê²€ì¦ ë° ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 
          - ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€í•˜ë©´ì„œ ë³´ì•ˆ ê°•í™”
          
          ğŸ¤– Generated with Claude Code Auto-Fix
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # í˜„ì¬ ë¸Œëœì¹˜ì— í‘¸ì‹œ
          git push origin HEAD
      
      - name: Auto-Fix Summary
        if: always()
        run: |
          echo "## ğŸ¤– Claude Auto-Fix ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.auto-fix.outcome }}" == "success" ]; then
            echo "âœ… **ìë™ ìˆ˜ì • ì™„ë£Œ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
              echo "**ë³€ê²½ì‚¬í•­**: ì½”ë“œê°€ ìë™ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
              echo "**ì»¤ë°‹**: ìƒˆë¡œìš´ ìˆ˜ì • ì»¤ë°‹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            else
              echo "**ë³€ê²½ì‚¬í•­**: ìˆ˜ì •ì´ í•„ìš”í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ìˆ˜ì • ì„¸ë¶€ì‚¬í•­**:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.auto-fix.outputs.result || 'No detailed output available' }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ìë™ ìˆ˜ì • ì‹¤íŒ¨ ë˜ëŠ” ìŠ¤í‚µ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ì‚¬ìœ **: ${{ steps.auto-fix.outputs.error || 'Unknown error' }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ===== 2ë‹¨ê³„: ë³‘ë ¬ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ + ìë™ìˆ˜ì •) =====
  backend-test:
    name: Backend Tests
    runs-on: [self-hosted, linux]
    needs: [cancel-previous, claude-analysis, auto-fix]
    if: ${{ !inputs.skip_tests && (needs.claude-analysis.result == 'success' || needs.claude-analysis.result == 'skipped') }}
    outputs:
      test-status: ${{ steps.test-summary.outputs.status }}
      coverage: ${{ steps.backend-tests.outputs.backend-coverage }}
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: health_management
        ports:
          - 25432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7-alpine
        ports:
          - 26379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Load MCP Configuration for Testing
        id: test-mcp
        run: |
          if [ -f ".mcp.json" ]; then
            MCP_CONFIG=$(cat .mcp.json | jq -c .)
            echo "config<<EOF" >> $GITHUB_OUTPUT
            echo "$MCP_CONFIG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "config={}" >> $GITHUB_OUTPUT
          fi
      
      - name: Prepare Test Analysis Prompt
        id: test-prompt
        run: |
          cat > test-analysis-prompt.txt <<EOF
          You are Claude Test Analyst for SafeWork Pro backend testing.
          
          ğŸ¯ MCP-POWERED TEST ANALYSIS:
          
          **STEP 1: Pre-Test Analysis**
          1. Use mcp__serena__activate_project "."
          2. Use mcp__serena__get_symbols_overview "tests/" to understand test structure
          3. Use mcp__github__search_issues "test fail" to check known test issues
          4. Use mcp__memory__search_nodes "test patterns" for previous test insights
          
          **STEP 2: Test Coverage Analysis**
          1. Use mcp__serena__find_symbol "test_" to find all test functions
          2. Use mcp__serena__search_for_pattern "assert.*" to analyze assertions
          3. Use mcp__brave-search "pytest best practices medical systems"
          4. Create memory entities for test coverage gaps
          
          **STEP 3: Security Test Verification**
          Focus on:
          - Authentication tests for medical data access
          - Authorization tests for patient records
          - Input validation tests for Korean characters
          - Database security tests
          - API endpoint security tests
          
          **STEP 4: Korean Compliance Testing**
          1. Search for "Korean medical software testing standards"
          2. Verify personal data handling in tests
          3. Check test data anonymization
          4. Ensure GDPR/Korean privacy law compliance in test data
          
          **TASK**: Analyze the testing approach and suggest improvements before running tests.
          EOF
          
          PROMPT=$(cat test-analysis-prompt.txt)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Analyze Tests with Claude
        id: test-analysis
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: ${{ steps.test-prompt.outputs.prompt }}
          mcp_config: ${{ steps.test-mcp.outputs.config }}
          allowed_tools: "Bash(pytest:*),View,GlobTool,GrepTool,mcp__serena__*,mcp__github__*,mcp__memory__*,mcp__brave-search__*"
          max_turns: 5
          timeout_minutes: 10
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: test_analysis
            SERENA_WORKSPACE: ${{ github.workspace }}
        continue-on-error: true
      
      - name: Run Backend Tests
        id: backend-tests
        env:
          DATABASE_URL: postgresql://admin:password@localhost:25432/health_management
          REDIS_URL: redis://localhost:26379/0
          JWT_SECRET: test-secret-key
          PYTHONPATH: ${{ github.workspace }}
          npm_config_cache: ${{ runner.temp }}/.npm
        timeout-minutes: 10
        run: |
          echo "ğŸ§ª Running backend tests..."
          echo "ğŸ“‹ Pre-test analysis completed: ${{ steps.test-analysis.outcome }}"
          
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pytest tests/ -v --cov=src --cov-report=term --cov-report=html --cov-fail-under=70 --timeout=300 -x | tee test-output.txt
          
          # Coverage ì¶”ì¶œ
          coverage=$(grep -oP 'TOTAL.*\K\d+(?=%)' test-output.txt || echo "0")
          echo "backend-coverage=$coverage" >> $GITHUB_OUTPUT
      
      - name: Analyze Test Results with MCP
        if: always()
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Analyze the test results and coverage for SafeWork Pro backend.
            
            ğŸ¯ MCP ANALYSIS WORKFLOW:
            1. Use mcp__memory__create_entities for test failures and coverage gaps
            2. Use mcp__github__search_issues to check if failures are known issues  
            3. Use mcp__sequential-thinking__sequentialthinking for root cause analysis
            4. Use mcp__brave-search__brave_web_search for Korean medical testing standards
            5. Use mcp__serena__search_for_pattern to find test-related code issues
            
            ğŸ“Š TEST RESULTS:
            - Test outcome: ${{ steps.backend-tests.outcome }}
            - Coverage: ${{ steps.backend-tests.outputs.backend-coverage }}%
            
            Focus on Korean healthcare compliance testing and medical data security.
          mcp_config: ${{ steps.test-mcp.outputs.config }}
          allowed_tools: "View,GrepTool,mcp__memory__*,mcp__github__*,mcp__sequential-thinking__*,mcp__brave-search__*,mcp__serena__*"
          max_turns: 5
          timeout_minutes: 8
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: test_result_analysis
        continue-on-error: true
      
      - name: Test Summary
        id: test-summary
        if: always()
        run: |
          if [ "${{ steps.backend-tests.outcome }}" == "success" ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

  frontend-test:
    name: Frontend Tests
    runs-on: [self-hosted, linux]
    needs: [cancel-previous, claude-analysis, auto-fix]
    if: ${{ !inputs.skip_tests && (needs.claude-analysis.result == 'success' || needs.claude-analysis.result == 'skipped') }}
    outputs:
      test-status: ${{ steps.test-summary.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Run Frontend Tests
        working-directory: frontend
        run: |
          npm ci
          npm run lint || true
          npm run test -- --passWithNoTests || true
          npm run build
      
      - name: Test Summary
        id: test-summary
        if: always()
        run: |
          echo "status=passed" >> $GITHUB_OUTPUT

  # ===== 3ë‹¨ê³„: ë³´ì•ˆ ìŠ¤ìº” (ë³‘ë ¬) =====
  security-scan:
    name: Security Scan with MCP Analysis
    runs-on: [self-hosted, linux]
    needs: [cancel-previous, claude-analysis, auto-fix]
    if: ${{ (needs.claude-analysis.result == 'success' || needs.claude-analysis.result == 'skipped') }}
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load MCP Configuration
        id: security-mcp
        run: |
          if [ -f ".mcp.json" ]; then
            MCP_CONFIG=$(cat .mcp.json | jq -c .)
            echo "config<<EOF" >> $GITHUB_OUTPUT
            echo "$MCP_CONFIG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "config={}" >> $GITHUB_OUTPUT
          fi
      
      - name: Pre-Scan Security Analysis
        id: pre-scan
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Perform comprehensive security analysis for SafeWork Pro before Trivy scan.
            
            ğŸ¯ MCP SECURITY ANALYSIS:
            1. Use mcp__serena__activate_project "."
            2. Use mcp__serena__search_for_pattern for security patterns:
               - "password.*=|secret.*=|key.*=" (hardcoded secrets)
               - "sql.*format|execute.*%" (SQL injection)
               - "innerHTML|eval|exec" (XSS/code injection)
               - "import.*os|subprocess|shell" (command injection)
            3. Use mcp__brave-search__brave_web_search for Korean medical security standards
            4. Use mcp__github__search_issues "security vulnerability" to check known issues
            5. Use mcp__memory__create_entities for found vulnerabilities
            
            Focus on Korean healthcare data protection and medical record security.
          mcp_config: ${{ steps.security-mcp.outputs.config }}
          allowed_tools: "View,GlobTool,GrepTool,mcp__serena__*,mcp__github__*,mcp__memory__*,mcp__brave-search__*"
          max_turns: 8
          timeout_minutes: 12
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: security_pre_scan
            SERENA_WORKSPACE: ${{ github.workspace }}
        continue-on-error: true
      
      - name: Run Trivy Scanner
        id: trivy-scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'json'
          output: 'trivy-results.json'
      
      - name: Analyze Trivy Results with MCP
        if: always()
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Analyze Trivy security scan results for SafeWork Pro medical system.
            
            ğŸ¯ MCP POST-SCAN ANALYSIS:
            1. Use View to read trivy-results.json
            2. Use mcp__memory__create_entities for each vulnerability found
            3. Use mcp__memory__create_relations between vulnerabilities and affected components
            4. Use mcp__brave-search__brave_web_search for Korean medical compliance requirements
            5. Use mcp__sequential-thinking__sequentialthinking for risk assessment
            6. Use mcp__github__search_issues to check if vulnerabilities are known
            
            ğŸ¥ KOREAN MEDICAL COMPLIANCE FOCUS:
            - ì˜ë£Œë²• compliance for patient data
            - ê°œì¸ì •ë³´ë³´í˜¸ë²• requirements
            - Medical record encryption standards
            - Healthcare system security guidelines
            
            Generate prioritized remediation plan for Korean healthcare environment.
          mcp_config: ${{ steps.security-mcp.outputs.config }}
          allowed_tools: "View,GlobTool,GrepTool,mcp__memory__*,mcp__github__*,mcp__sequential-thinking__*,mcp__brave-search__*"
          max_turns: 6
          timeout_minutes: 10
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
            PROJECT_NAME: SafeWork Pro
            ANALYSIS_MODE: security_post_scan
        continue-on-error: true

  # ===== í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ =====
  test:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    outputs:
      test-status: ${{ steps.summary.outputs.status }}
      coverage: ${{ needs.backend-test.outputs.coverage }}
    
    steps:
      - name: Combine Test Results
        id: summary
        run: |
          BACKEND_STATUS="${{ needs.backend-test.outputs.test-status }}"
          FRONTEND_STATUS="${{ needs.frontend-test.outputs.test-status }}"
          
          if [ "$BACKEND_STATUS" == "passed" ] && [ "$FRONTEND_STATUS" == "passed" ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "âœ… All tests passed!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Some tests failed!"
            echo "Backend: $BACKEND_STATUS, Frontend: $FRONTEND_STATUS"
          fi

  # ===== 4ë‹¨ê³„: Docker ë¹Œë“œ ë° í‘¸ì‹œ =====
  build-and-push:
    name: Build & Push Docker Image
    needs: [test, security-scan]
    runs-on: [self-hosted, linux]
    if: needs.test.outputs.test-status == 'passed'
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate metadata
        id: meta
        run: |
          # í™˜ê²½ë³„ íƒœê·¸ ìƒì„±
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            ENV="pr-${{ github.event.pull_request.number }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          else
            ENV="dev"
          fi
          
          TAG="${ENV}-$(date +%Y%m%d)-${GITHUB_SHA:0:7}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
      
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # ===== 5ë‹¨ê³„: ArgoCD ë°°í¬ íŠ¸ë¦¬ê±° =====
  deploy:
    name: Deploy via ArgoCD
    needs: [build-and-push]
    runs-on: [self-hosted, linux]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: 
      name: production
      url: https://safework.jclee.me
    
    steps:
      - name: Notify ArgoCD
        run: |
          echo "ğŸš€ Deployment triggered!"
          echo "ğŸ“¦ New image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}"
          echo "ğŸ”„ ArgoCD will automatically sync within 3 minutes"
          
      - name: Wait and Verify
        run: |
          echo "â³ Waiting for ArgoCD sync..."
          sleep 180
          
          # Health check
          MAX_ATTEMPTS=10
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -s -o /dev/null -w "%{http_code}" https://safework.jclee.me/health | grep -q "200"; then
              echo "âœ… Deployment successful!"
              exit 0
            fi
            echo "Attempt $i/$MAX_ATTEMPTS..."
            sleep 30
          done
          
          echo "âŒ Deployment verification failed"
          exit 1

  # ===== ìµœì¢…: ê²°ê³¼ ì•Œë¦¼ =====
  notify:
    name: Pipeline Summary
    needs: [claude-analysis, auto-fix, backend-test, frontend-test, test, security-scan, build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ğŸš€ SafeWork Pro Pipeline Summary
          
          ## ğŸ“Š Results
          - ğŸ¤– Claude Review: ${{ needs.claude-analysis.outputs.review-status || 'skipped' }}
          - ğŸ”§ Auto-Fix: ${{ needs.auto-fix.result || 'skipped' }}
          - ğŸ§ª Backend Tests: ${{ needs.backend-test.outputs.test-status || 'skipped' }} (Coverage: ${{ needs.backend-test.outputs.coverage || 'N/A' }}%)
          - ğŸ¨ Frontend Tests: ${{ needs.frontend-test.outputs.test-status || 'skipped' }}
          - ğŸ”’ Security Scan: ${{ needs.security-scan.result || 'skipped' }}
          - ğŸ—ï¸ Build: ${{ needs.build-and-push.result }}
          - ğŸš¢ Deploy: ${{ needs.deploy.result }}
          
          ## ğŸ“¦ Deployment Info
          - Image: \`${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag || 'N/A' }}\`
          - Environment: Production
          - URL: https://safework.jclee.me
          
          ---
          Generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF
      
      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸš€ Pipeline Results
            
            | Stage | Status |
            |-------|--------|
            | ğŸ¤– Claude Review | ${{ needs.claude-analysis.outputs.review-status || 'â­ï¸ skipped' }} |
            | ğŸ”§ Auto-Fix | ${{ needs.auto-fix.result || 'â­ï¸ skipped' }} |
            | ğŸ§ª Backend Tests | ${{ needs.backend-test.outputs.test-status || 'â­ï¸ skipped' }} |
            | ğŸ¨ Frontend Tests | ${{ needs.frontend-test.outputs.test-status || 'â­ï¸ skipped' }} |
            | ğŸ”’ Security Scan | ${{ needs.security-scan.result || 'â­ï¸ skipped' }} |
            | ğŸ“¦ Build | ${{ needs.build-and-push.result }} |
            | ğŸš¢ Deploy | ${{ needs.deploy.result || 'N/A' }} |
            
            **Coverage**: ${{ needs.backend-test.outputs.coverage || 'N/A' }}%
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
name: SafeWork Pro - CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  REGISTRY_URL: registry.jclee.me
  IMAGE_NAME: safework
  DOCKER_BUILDKIT: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  claude-analysis:
    name: Claude Code MCP Analysis
    runs-on: [self-hosted, linux]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check Claude Code Installation
        id: claude_check
        run: |
          echo "ğŸ” Claude Code ì„¤ì¹˜ í™•ì¸..."
          if command -v claude &> /dev/null; then
            echo "âœ… Claude Code CLI ë°œê²¬: $(which claude)"
            echo "ğŸ“‹ ë²„ì „: $(claude --version || echo 'Unknown')"
            echo "claude_available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Claude Code CLIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "claude_available=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Claude OAuth Status
        if: steps.claude_check.outputs.claude_available == 'true'
        id: oauth_check
        run: |
          echo "ğŸ” Claude Code OAuth ìƒíƒœ í™•ì¸..."
          
          # Check if user is logged in
          if claude auth status &>/dev/null; then
            echo "âœ… Claude Code OAuth ì¸ì¦ ì™„ë£Œ"
            echo "oauth_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Claude Code OAuth ì¸ì¦ í•„ìš”"
            echo "oauth_ready=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Claude Code OAuth
        if: steps.claude_check.outputs.claude_available == 'true' && steps.oauth_check.outputs.oauth_ready == 'false'
        run: |
          echo "ğŸ” Claude Code OAuth ì„¤ì •..."
          # OAuth ì„¤ì •ì´ í•„ìš”í•œ ê²½ìš°ì˜ ì²˜ë¦¬
          echo "âš ï¸ Claude Code OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"
          echo "ğŸ‘¤ Self-hosted runnerì—ì„œ ìˆ˜ë™ìœ¼ë¡œ 'claude auth login' ì‹¤í–‰ í•„ìš”"
          exit 1
      
      - name: Run Claude Code MCP Analysis
        if: steps.claude_check.outputs.claude_available == 'true' && steps.oauth_check.outputs.oauth_ready == 'true'
        run: |
          echo "ğŸ” SafeWork Pro MCP ë¶„ì„ ì‹œì‘..."
          
          # Create analysis prompt
          cat << 'EOF' > analysis_prompt.md
          SafeWork Pro ë³´ì•ˆ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.
          
          MCP ë„êµ¬ ì‚¬ìš© ìš”ì²­:
          1. mcp__github__search_issues with "security" 
          2. mcp__memory__search_nodes with "safework"
          3. mcp__brave-search__brave_web_search for "Korean medical data protection"
          4. mcp__sequential-thinking__sequentialthinking for analysis
          
          ì§‘ì¤‘ ë¶„ì„ ì˜ì—­:
          - SQL injection, XSS ì·¨ì•½ì  ìŠ¤ìº”
          - í•œêµ­ ì˜ë£Œë²•/ê°œì¸ì •ë³´ë³´í˜¸ë²• ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬
          - ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ ê²°í•¨ ê²€í† 
          - ì˜ë£Œ ë°ì´í„° ë³´ì•ˆ ê²€ì¦
          - FastAPI ì—”ë“œí¬ì¸íŠ¸ ë³´ì•ˆ ê²€í† 
          - ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ ì„¤ì • í™•ì¸
          
          ì¤‘ìš” ì´ìŠˆ ë°œê²¬ ì‹œ GitHub Issueë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
          EOF
          
          echo "ğŸ“ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ"
          
          # Execute Claude Code analysis
          echo "ğŸ¤– Claude Code ë¶„ì„ ì‹¤í–‰..."
          claude chat --file analysis_prompt.md \
            --message "SafeWork Pro í”„ë¡œì íŠ¸ì˜ ë³´ì•ˆ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ìœ„ì˜ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì² ì €í•œ ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”." \
            || echo "âš ï¸ Claude Code ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
      
      - name: Fallback Analysis Summary
        if: steps.claude_check.outputs.claude_available == 'false'
        run: |
          echo "ğŸ“‹ Claude Codeë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ê¸°ë³¸ ë¶„ì„ ìš”ì•½ì„ ì œê³µí•©ë‹ˆë‹¤"
          echo ""
          echo "ğŸ” SafeWork Pro ìˆ˜ë™ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
          echo "1. âœ… .gitignoreì— ë¯¼ê°í•œ íŒŒì¼ ì¶”ê°€ë¨"
          echo "2. âœ… í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ì œê±°ë¨"
          echo "3. âœ… OAuth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ë¨"
          echo "4. âš ï¸ ì¶”ê°€ ë³´ì•ˆ ìŠ¤ìº” ê¶Œì¥"

  backend-test:
    name: Backend Tests
    runs-on: [self-hosted, linux]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: health_management
        ports:
          - 25432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7-alpine
        ports:
          - 26379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout
      
      - name: Run backend tests
        env:
          DATABASE_URL: postgresql://admin:password@localhost:25432/health_management
          REDIS_URL: redis://localhost:26379/0
          JWT_SECRET: test-secret-key
          PYTHONPATH: ${{ github.workspace }}
        timeout-minutes: 10
        run: |
          echo "ğŸ§ª Running backend tests..."
          pytest tests/ -v --cov=src --cov-report=term --cov-fail-under=70 --timeout=300 -x

  frontend-test:
    name: Frontend Tests  
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run frontend tests
        working-directory: frontend
        run: |
          npm run lint
          npm run test -- --passWithNoTests
          npm run build

  security-scan:
    name: Security Scan
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build:
    name: Build Docker Image
    needs: [backend-test, frontend-test, security-scan]
    runs-on: [self-hosted, linux]
    if: github.ref == 'refs/heads/main' && (success() || failure())
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate metadata
        id: meta
        run: |
          VERSION=$(date +%Y.%m.%d)
          BUILD_NUM=${{ github.run_number }}
          SHA_SHORT=${GITHUB_SHA:0:7}
          TAG="prod-${VERSION}.${BUILD_NUM}-${SHA_SHORT}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production
    needs: [build]
    runs-on: [self-hosted, linux]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://safework.jclee.me
    
    steps:
      - name: Notify deployment
        run: |
          echo "ğŸš€ Docker image pushed to registry"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest"
          echo "ğŸ”„ ArgoCD will automatically sync the deployment"
      
      - name: Verify deployment
        run: |
          echo "â³ Waiting for ArgoCD sync..."
          sleep 60
          
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://safework.jclee.me/health || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Application is healthy!"
              break
            else
              echo "â³ Waiting for application... (attempt $i/10, status: $HTTP_STATUS)"
              sleep 30
            fi
          done
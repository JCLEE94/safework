name: SafeWork Pro - CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  REGISTRY_URL: registry.jclee.me
  IMAGE_NAME: safework
  DOCKER_BUILDKIT: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  claude-analysis:
    name: Claude Code MCP Analysis
    runs-on: [self-hosted, linux]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check and Install Claude Code
        id: claude_check
        run: |
          echo "ğŸ” Claude Code ì„¤ì¹˜ ë° ì—…ë°ì´íŠ¸ í™•ì¸..."
          
          # Claude Code ìë™ ì„¤ì¹˜/ì—…ë°ì´íŠ¸
          if ! command -v claude &> /dev/null; then
            echo "ğŸ“¦ Claude Code CLI ì„¤ì¹˜ ì¤‘..."
            
            # Claude Code ì„¤ì¹˜ ì‹œë„ (ì—¬ëŸ¬ ë°©ë²•)
            if command -v npm &> /dev/null; then
              echo "ğŸ”§ npmì„ í†µí•œ ì„¤ì¹˜ ì‹œë„..."
              npm install -g @anthropic/claude-code || echo "npm ì„¤ì¹˜ ì‹¤íŒ¨"
            fi
            
            # ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë°©ë²•
            if ! command -v claude &> /dev/null; then
              echo "ğŸ”§ ì§ì ‘ ë‹¤ìš´ë¡œë“œë¥¼ í†µí•œ ì„¤ì¹˜ ì‹œë„..."
              curl -fsSL https://claude.ai/install.sh | bash || echo "ì§ì ‘ ì„¤ì¹˜ ì‹¤íŒ¨"
            fi
            
            # ìµœì¢… í™•ì¸
            if command -v claude &> /dev/null; then
              echo "âœ… Claude Code CLI ì„¤ì¹˜ ì„±ê³µ!"
            else
              echo "âŒ Claude Code CLI ìë™ ì„¤ì¹˜ ì‹¤íŒ¨"
              echo "ğŸ“‹ ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ: ./setup-claude-code-runner.sh ì‹¤í–‰"
            fi
          else
            echo "âœ… Claude Code CLI ë°œê²¬: $(which claude)"
            
            # ë²„ì „ í™•ì¸ ë° ì—…ë°ì´íŠ¸ ì²´í¬
            CURRENT_VERSION=$(claude --version 2>/dev/null || echo "Unknown")
            echo "ğŸ“‹ í˜„ì¬ ë²„ì „: $CURRENT_VERSION"
            
            # ì—…ë°ì´íŠ¸ ì²´í¬ (npm ê¸°ë°˜)
            if command -v npm &> /dev/null; then
              echo "ğŸ”„ ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘..."
              npm outdated -g @anthropic/claude-code || echo "ì—…ë°ì´íŠ¸ ì²´í¬ ì™„ë£Œ"
            fi
          fi
          
          # ìµœì¢… ìƒíƒœ ì„¤ì •
          if command -v claude &> /dev/null; then
            echo "claude_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Claude Code ì¤€ë¹„ ì™„ë£Œ"
          else
            echo "claude_available=false" >> $GITHUB_OUTPUT
            echo "âŒ Claude Code ì‚¬ìš© ë¶ˆê°€"
          fi
      
      - name: Check Claude OAuth Status
        if: steps.claude_check.outputs.claude_available == 'true'
        id: oauth_check
        run: |
          echo "ğŸ” Claude Code OAuth ìƒíƒœ í™•ì¸..."
          
          # Check if user is logged in
          if claude auth status &>/dev/null; then
            echo "âœ… Claude Code OAuth ì¸ì¦ ì™„ë£Œ"
            echo "oauth_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Claude Code OAuth ì¸ì¦ í•„ìš”"
            echo "oauth_ready=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Claude Code OAuth
        if: steps.claude_check.outputs.claude_available == 'true' && steps.oauth_check.outputs.oauth_ready == 'false'
        run: |
          echo "ğŸ” Claude Code OAuth ì„¤ì •..."
          # OAuth ì„¤ì •ì´ í•„ìš”í•œ ê²½ìš°ì˜ ì²˜ë¦¬
          echo "âš ï¸ Claude Code OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"
          echo "ğŸ‘¤ Self-hosted runnerì—ì„œ ìˆ˜ë™ìœ¼ë¡œ 'claude auth login' ì‹¤í–‰ í•„ìš”"
          exit 1
      
      - name: Enhanced MCP Tool Chain Analysis
        if: steps.claude_check.outputs.claude_available == 'true' && steps.oauth_check.outputs.oauth_ready == 'true'
        run: |
          echo "ğŸ§  SafeWork Pro ê³ ê¸‰ MCP ë¶„ì„ ì‹œì‘..."
          
          # Create comprehensive analysis prompt
          cat << 'EOF' > enhanced_analysis_prompt.md
          # SafeWork Pro ì¢…í•© AI ë¶„ì„
          
          SafeWork ProëŠ” í•œêµ­ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ë‹¤ìŒ MCP ë„êµ¬ ì²´ì¸ì„ í™œìš©í•˜ì—¬ ì¢…í•©ì ì¸ ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.
          
          ## ğŸ”§ MCP ë„êµ¬ ì²´ì¸ ì‚¬ìš© ê³„íš:
          
          ### 1ë‹¨ê³„: í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
          - `mcp__github__search_issues`ë¡œ ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆ ê²€ìƒ‰
          - `mcp__github__list_pull_requests`ë¡œ ìµœê·¼ ë³€ê²½ì‚¬í•­ ë¶„ì„
          - `mcp__memory__search_nodes`ë¡œ ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ ì¡°íšŒ
          
          ### 2ë‹¨ê³„: ì™¸ë¶€ ë¦¬ì„œì¹˜
          - `mcp__brave-search__brave_web_search`ë¡œ "Korean medical data protection 2024" ê²€ìƒ‰
          - `mcp__brave-search__brave_web_search`ë¡œ "Korean occupational safety health law 2024" ê²€ìƒ‰
          - `mcp__brave-search__brave_web_search`ë¡œ "FastAPI security best practices" ê²€ìƒ‰
          
          ### 3ë‹¨ê³„: ì²´ê³„ì  ë¶„ì„
          - `mcp__sequential-thinking__sequentialthinking`ë¡œ ë‹¨ê³„ë³„ ë¶„ì„ ìˆ˜í–‰
          - `mcp__shrimp-task-manager__plan_task`ë¡œ ê°œì„  ì‘ì—… ê³„íš ìˆ˜ë¦½
          
          ### 4ë‹¨ê³„: ë©”ëª¨ë¦¬ ì €ì¥
          - `mcp__memory__create_entities`ë¡œ ë¶„ì„ ê²°ê³¼ ì €ì¥
          - `mcp__memory__create_relations`ë¡œ ì—°ê´€ê´€ê³„ ì €ì¥
          
          ## ğŸ¯ ì§‘ì¤‘ ë¶„ì„ ì˜ì—­:
          
          ### ë³´ì•ˆ ì»´í”Œë¼ì´ì–¸ìŠ¤
          1. **í•œêµ­ ë²•ê·œ ì¤€ìˆ˜**:
             - ê°œì¸ì •ë³´ë³´í˜¸ë²• (ì˜ë£Œì •ë³´ í¬í•¨)
             - ì‚°ì—…ì•ˆì „ë³´ê±´ë²•
             - ì •ë³´í†µì‹ ë§ë²•
          
          2. **ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ**:
             - SQL Injection ì·¨ì•½ì  ìŠ¤ìº”
             - XSS (Cross-Site Scripting) ê²€ì‚¬
             - CSRF ê³µê²© ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜
             - JWT í† í° ë³´ì•ˆ ê²€ì¦
          
          3. **API ë³´ì•ˆ**:
             - FastAPI ì—”ë“œí¬ì¸íŠ¸ ì¸ì¦/ì¸ê°€
             - Rate limiting êµ¬í˜„
             - ì…ë ¥ ê²€ì¦ ë° ì‚¬ë‹ˆíƒ€ì´ì œì´ì…˜
             - HTTPS/TLS ì„¤ì •
          
          ### ì•„í‚¤í…ì²˜ ë³´ì•ˆ
          1. **ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ**:
             - PostgreSQL ì ‘ê·¼ ì œì–´
             - ë¯¼ê°í•œ ë°ì´í„° ì•”í˜¸í™”
             - ë°±ì—… ë°ì´í„° ë³´ì•ˆ
          
          2. **ì»¨í…Œì´ë„ˆ ë³´ì•ˆ**:
             - Docker ì´ë¯¸ì§€ ì·¨ì•½ì 
             - ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ë³´ì•ˆ
             - ë„¤íŠ¸ì›Œí¬ ì„¸ê·¸ë©˜í…Œì´ì…˜
          
          3. **CI/CD ë³´ì•ˆ**:
             - Secrets ê´€ë¦¬
             - Supply chain ë³´ì•ˆ
             - ì½”ë“œ ìŠ¤ìº” ìë™í™”
          
          ### ì„±ëŠ¥ ìµœì í™”
          1. **ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”**:
             - N+1 ì¿¼ë¦¬ ë¬¸ì œ ê²€ì¶œ
             - ì¸ë±ìŠ¤ ìµœì í™” ì œì•ˆ
             - ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„
          
          2. **ìºì‹± ì „ëµ**:
             - Redis í™œìš© ìµœì í™”
             - CDN êµ¬ì„± ì œì•ˆ
             - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”
          
          ## ğŸ“‹ ë¶„ì„ ê²°ê³¼ ì•¡ì…˜:
          
          1. **ì¤‘ìš” ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ ì‹œ**:
             - GitHub Issue ìë™ ìƒì„± (priority:high, security ë¼ë²¨)
             - ìƒì„¸í•œ ì·¨ì•½ì  ì„¤ëª… ë° ìˆ˜ì • ë°©ì•ˆ ì œì‹œ
          
          2. **ê°œì„  ì‚¬í•­ ì œì•ˆ ì‹œ**:
             - Pull Request í…œí”Œë¦¿ ìƒì„±
             - ë‹¨ê³„ë³„ êµ¬í˜„ ê°€ì´ë“œ ì œê³µ
          
          3. **ì»´í”Œë¼ì´ì–¸ìŠ¤ ë¬¸ì œ ì‹œ**:
             - ë²•ì  ìš”êµ¬ì‚¬í•­ ìƒì„¸ ì„¤ëª…
             - êµ¬ì²´ì ì¸ í•´ê²°ì±… ì œì‹œ
          
          ## ğŸš€ ì‹œì‘ ëª…ë ¹:
          
          ìœ„ì˜ ê³„íšì— ë”°ë¼ SafeWork Pro í”„ë¡œì íŠ¸ì˜ ì¢…í•©ì ì¸ ë¶„ì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”. 
          ê° ë‹¨ê³„ë³„ë¡œ MCP ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ê³ , 
          ë°œê²¬ëœ ì´ìŠˆëŠ” ì¦‰ì‹œ GitHubì— ë³´ê³ í•´ì£¼ì„¸ìš”.
          EOF
          
          echo "ğŸ“ ê³ ê¸‰ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ"
          
          # Execute enhanced Claude analysis with MCP tools
          echo "ğŸ¤– Claude Code MCP ë„êµ¬ ì²´ì¸ ë¶„ì„ ì‹¤í–‰..."
          claude chat --file enhanced_analysis_prompt.md \
            --message "SafeWork Proì˜ ì¢…í•©ì ì¸ ë³´ì•ˆ ë° ì„±ëŠ¥ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. MCP ë„êµ¬ ì²´ì¸ì„ ì ê·¹ í™œìš©í•´ì£¼ì„¸ìš”." \
            --timeout 3600 \
            || echo "âš ï¸ Claude Code MCP ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          
          echo "ğŸ“Š ë¶„ì„ ì™„ë£Œ - ê²°ê³¼ëŠ” ìœ„ì˜ ì¶œë ¥ì„ í™•ì¸í•˜ì„¸ìš”"
      
      - name: Fallback Analysis Summary
        if: steps.claude_check.outputs.claude_available == 'false'
        run: |
          echo "ğŸ“‹ Claude Codeë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ê¸°ë³¸ ë¶„ì„ ìš”ì•½ì„ ì œê³µí•©ë‹ˆë‹¤"
          echo ""
          echo "ğŸ” SafeWork Pro ìˆ˜ë™ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
          echo "1. âœ… .gitignoreì— ë¯¼ê°í•œ íŒŒì¼ ì¶”ê°€ë¨"
          echo "2. âœ… í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ì œê±°ë¨"
          echo "3. âœ… OAuth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ë¨"
          echo "4. âš ï¸ ì¶”ê°€ ë³´ì•ˆ ìŠ¤ìº” ê¶Œì¥"

  backend-test:
    name: Backend Tests
    runs-on: [self-hosted, linux]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: health_management
        ports:
          - 25432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7-alpine
        ports:
          - 26379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout
      
      - name: Run backend tests
        env:
          DATABASE_URL: postgresql://admin:password@localhost:25432/health_management
          REDIS_URL: redis://localhost:26379/0
          JWT_SECRET: test-secret-key
          PYTHONPATH: ${{ github.workspace }}
        timeout-minutes: 10
        run: |
          echo "ğŸ§ª Running backend tests..."
          pytest tests/ -v --cov=src --cov-report=term --cov-fail-under=70 --timeout=300 -x

  frontend-test:
    name: Frontend Tests  
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run frontend tests
        working-directory: frontend
        run: |
          npm run lint
          npm run test -- --passWithNoTests
          npm run build

  security-scan:
    name: Security Scan
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build:
    name: Build Docker Image
    needs: [backend-test, frontend-test, security-scan]
    runs-on: [self-hosted, linux]
    if: github.ref == 'refs/heads/main' && (success() || failure())
    
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate metadata
        id: meta
        run: |
          VERSION=$(date +%Y.%m.%d)
          BUILD_NUM=${{ github.run_number }}
          SHA_SHORT=${GITHUB_SHA:0:7}
          TAG="prod-${VERSION}.${BUILD_NUM}-${SHA_SHORT}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production via ArgoCD
    needs: [build]
    runs-on: [self-hosted, linux]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://safework.jclee.me
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update K8s manifest
        run: |
          echo "ğŸ“ Updating deployment manifest..."
          IMAGE_TAG="${{ needs.build.outputs.tag }}"
          sed -i "s|image: registry.jclee.me/safework:.*|image: registry.jclee.me/safework:${IMAGE_TAG}|g" k8s/safework/deployment.yaml
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add k8s/safework/deployment.yaml
          git commit -m "chore: update image to ${IMAGE_TAG} [skip ci]"
          git push
      
      - name: Trigger ArgoCD sync
        run: |
          echo "ğŸ”„ ArgoCD will automatically sync the deployment"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.tag }}"
          echo "ğŸ”— ArgoCD: https://argo.jclee.me/applications/safework"
      
      - name: Verify deployment
        run: |
          echo "â³ Waiting for ArgoCD sync..."
          sleep 90
          
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://safework.jclee.me/health || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Application is healthy!"
              curl -s https://safework.jclee.me/health | jq .
              break
            else
              echo "â³ Waiting for application... (attempt $i/10, status: $HTTP_STATUS)"
              sleep 30
            fi
          done
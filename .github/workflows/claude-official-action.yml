name: Claude Code Official Action

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Claude Installation
        id: claude_check
        run: |
          echo "ğŸ” Claude Code ì„¤ì¹˜ í™•ì¸..."
          if command -v claude &> /dev/null; then
            echo "âœ… Claude Code CLI ë°œê²¬: $(which claude)"
            echo "ğŸ“‹ ë²„ì „: $(claude --version || echo 'Unknown')"
            echo "claude_available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Claude Code CLIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "claude_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Action (Official)
        if: steps.claude_check.outputs.claude_available == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "60"
          allowed_tools: |
            mcp__github__*
            mcp__memory__*
            mcp__sequential-thinking__*
            mcp__brave-search__*
            mcp__shrimp-task-manager__*
          system_prompt: |
            SafeWork ProëŠ” í•œêµ­ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
            
            ì£¼ìš” ê¸°ëŠ¥:
            - ê·¼ë¡œì ê±´ê°• ê´€ë¦¬
            - ê±´ê°• ê²€ì§„ ê¸°ë¡ ê´€ë¦¬
            - ì‘ì—…í™˜ê²½ ëª¨ë‹ˆí„°ë§
            - í™”í•™ë¬¼ì§ˆ ê´€ë¦¬ (MSDS)
            - ì‚¬ê³  ë³´ê³  ì‹œìŠ¤í…œ
            
            ë¶„ì„ ì‹œ ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•´ì£¼ì„¸ìš”:
            1. í•œêµ­ ì‚°ì—…ì•ˆì „ë³´ê±´ë²•/ê°œì¸ì •ë³´ë³´í˜¸ë²• ì»´í”Œë¼ì´ì–¸ìŠ¤
            2. ì˜ë£Œ ë°ì´í„° ë³´ì•ˆ (ë¯¼ê°ì •ë³´ ì²˜ë¦¬)
            3. FastAPI ì—”ë“œí¬ì¸íŠ¸ ë³´ì•ˆ
            4. PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ
            5. Docker ì»¨í…Œì´ë„ˆ ë³´ì•ˆ
            
            ì¤‘ìš” ì´ìŠˆ ë°œê²¬ ì‹œ GitHub Issueë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

      - name: Fallback Analysis (No Claude CLI)
        if: steps.claude_check.outputs.claude_available == 'false'
        run: |
          echo "ğŸ“‹ Claude CLIê°€ ì—†ì–´ ê¸°ë³¸ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤"
          echo ""
          echo "ğŸ” SafeWork Pro ê¸°ë³¸ ë³´ì•ˆ ì²´í¬:"
          echo "1. âœ… ë¯¼ê°í•œ íŒŒì¼ì´ .gitignoreì— í¬í•¨ë¨"
          echo "2. âœ… í•˜ë“œì½”ë”©ëœ ì¸ì¦ì •ë³´ ì œê±°ë¨"
          echo "3. âœ… OAuth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ë¨"
          echo "4. âš ï¸ ì¶”ê°€ ë³´ì•ˆ ìŠ¤ìº” ê¶Œì¥ - Claude CLI ì„¤ì¹˜ í•„ìš”"
          echo ""
          echo "ğŸ’¡ Claude CLI ì„¤ì¹˜ ë°©ë²•:"
          echo "   ./setup-claude-code-runner.sh ì‹¤í–‰"
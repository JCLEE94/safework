name: Claude Simple Action (1íšŒ ì¸ì¦ ê¸°ë°˜)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  claude:
    name: Claude PR Assistant
    # @claude ë©˜ì…˜ì´ ìˆëŠ” ê²½ìš°ë§Œ ì‹¤í–‰
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check OAuth tokens
        id: oauth_check
        run: |
          echo "ğŸ” Claude OAuth í† í° ìƒíƒœ í™•ì¸..."
          
          ACCESS_TOKEN="${{ secrets.CLAUDE_ACCESS_TOKEN }}"
          REFRESH_TOKEN="${{ secrets.CLAUDE_REFRESH_TOKEN }}"
          EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
          
          if [ -n "$ACCESS_TOKEN" ] && [ -n "$REFRESH_TOKEN" ] && [ -n "$EXPIRES_AT" ]; then
            echo "âœ… OAuth í† í° ì¡´ì¬ í™•ì¸"
            
            # ë§Œë£Œ ì‹œê°„ í™•ì¸
            CURRENT_TIME=$(date +%s)
            if [ "$EXPIRES_AT" -gt "$CURRENT_TIME" ]; then
              TIME_LEFT=$(($EXPIRES_AT - $CURRENT_TIME))
              HOURS_LEFT=$((TIME_LEFT / 3600))
              echo "ğŸ• í† í° ìœ íš¨ ì‹œê°„: ${HOURS_LEFT}ì‹œê°„"
              echo "tokens_valid=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ í† í° ë§Œë£Œë¨ - ê°±ì‹  í•„ìš”"
              echo "tokens_valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ OAuth í† í° ì—†ìŒ"
            echo "tokens_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude with OAuth (grll action)
        if: steps.oauth_check.outputs.tokens_valid == 'true'
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          timeout_minutes: "60"
          system_prompt: |
            SafeWork ProëŠ” í•œêµ­ ê±´ì„¤ì—… ë³´ê±´ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
            
            ì£¼ìš” ê¸°ëŠ¥:
            - ê·¼ë¡œì ê±´ê°• ê´€ë¦¬ 
            - ê±´ê°• ê²€ì§„ ê¸°ë¡ ê´€ë¦¬
            - ì‘ì—…í™˜ê²½ ëª¨ë‹ˆí„°ë§
            - í™”í•™ë¬¼ì§ˆ ê´€ë¦¬ (MSDS)
            - ì‚¬ê³  ë³´ê³  ì‹œìŠ¤í…œ
            
            ë¶„ì„ ì‹œ ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•´ì£¼ì„¸ìš”:
            1. í•œêµ­ ì‚°ì—…ì•ˆì „ë³´ê±´ë²•/ê°œì¸ì •ë³´ë³´í˜¸ë²• ì»´í”Œë¼ì´ì–¸ìŠ¤
            2. ì˜ë£Œ ë°ì´í„° ë³´ì•ˆ (ë¯¼ê°ì •ë³´ ì²˜ë¦¬)
            3. FastAPI ì—”ë“œí¬ì¸íŠ¸ ë³´ì•ˆ
            4. PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ
            5. Docker ì»¨í…Œì´ë„ˆ ë³´ì•ˆ
            
            ì¤‘ìš” ì´ìŠˆ ë°œê²¬ ì‹œ GitHub Issueë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
            ì‘ë‹µì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        continue-on-error: true

      - name: OAuth setup required
        if: steps.oauth_check.outputs.tokens_valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const message = [
              '## ğŸ” Claude OAuth ì¸ì¦ í•„ìš”',
              '',
              'âŒ Claude Code OAuth í† í°ì´ ì—†ê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
              '',
              '### ğŸ“‹ ì¸ì¦ ì„¤ì • ë°©ë²•:',
              '',
              '1. **OAuth ì›Œí¬í”Œë¡œìš° ì‹¤í–‰**:',
              '   â€¢ [Claude OAuth ì¸ì¦ ì‹¤í–‰](https://github.com/${{ github.repository }}/actions/workflows/claude-oauth-onetime.yml)',
              '   â€¢ "Run workflow" í´ë¦­ (ì½”ë“œëŠ” ë¹„ì›Œë‘ì„¸ìš”)',
              '',
              '2. **Claude ë¡œê·¸ì¸**:',
              '   â€¢ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì œê³µë˜ëŠ” URLë¡œ ì´ë™',
              '   â€¢ Claude ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸',
              '   â€¢ ì¸ì¦ ì½”ë“œ ë³µì‚¬',
              '',
              '3. **í† í° ì €ì¥**:',
              '   â€¢ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰',
              '   â€¢ \'code\' í•„ë“œì— ì¸ì¦ ì½”ë“œ ì…ë ¥',
              '   â€¢ "Run workflow" í´ë¦­',
              '',
              'ì„¤ì • ì™„ë£Œ í›„ ë‹¤ì‹œ @claudeë¥¼ ë©˜ì…˜í•´ì£¼ì„¸ìš”! ğŸ¤–'
            ].join('\n');

            // ì½”ë©˜íŠ¸ê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ ì´ìŠˆ/PRì— ì‘ë‹µ
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: message
              });
            } else if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }

      - name: Action summary
        if: always()
        run: |
          echo "ğŸ“Š Claude Action ì‹¤í–‰ ìš”ì•½"
          echo "========================="
          echo "OAuth í† í° ìœ íš¨: ${{ steps.oauth_check.outputs.tokens_valid }}"
          echo "ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "ì´ë²¤íŠ¸: ${{ github.event_name }}"
          
          if [ "${{ steps.oauth_check.outputs.tokens_valid }}" = "true" ]; then
            echo "âœ… Claude Action ì‹¤í–‰ ì™„ë£Œ"
          else
            echo "âš ï¸ OAuth ì¸ì¦ í•„ìš” - ìœ„ ë‹¨ê³„ë¥¼ ë”°ë¼ ì„¤ì •í•˜ì„¸ìš”"
          fi
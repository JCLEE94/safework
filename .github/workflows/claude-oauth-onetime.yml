name: Claude Code 1íšŒ OAuth ì¸ì¦

on:
  workflow_dispatch:
    inputs:
      code:
        description: 'ì¸ì¦ ì½”ë“œ (1ë‹¨ê³„ëŠ” ë¹„ì›Œë‘ì„¸ìš”)'
        required: false
        type: string
      reset_auth:
        description: 'ì¸ì¦ ì´ˆê¸°í™” (ê¸°ì¡´ í† í° ì‚­ì œ)'
        required: false
        type: boolean
        default: false

permissions:
  actions: write
  contents: read

jobs:
  claude-oauth-setup:
    name: Claude OAuth 1íšŒ ì¸ì¦ ì„¤ì •
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check authentication status
        id: auth_check
        run: |
          echo "ğŸ” Claude Code OAuth ìƒíƒœ í™•ì¸..."
          
          # ê¸°ì¡´ í† í° í™•ì¸
          ACCESS_TOKEN="${{ secrets.CLAUDE_ACCESS_TOKEN }}"
          REFRESH_TOKEN="${{ secrets.CLAUDE_REFRESH_TOKEN }}"
          EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
          
          if [ -n "$ACCESS_TOKEN" ] && [ -n "$REFRESH_TOKEN" ] && [ -n "$EXPIRES_AT" ]; then
            echo "existing_auth=true" >> $GITHUB_OUTPUT
            echo "âœ… ê¸°ì¡´ OAuth í† í° ë°œê²¬"
            
            # ë§Œë£Œ ì‹œê°„ í™•ì¸
            CURRENT_TIME=$(date +%s)
            if [ "$EXPIRES_AT" -gt "$CURRENT_TIME" ]; then
              TIME_LEFT=$(($EXPIRES_AT - $CURRENT_TIME))
              HOURS_LEFT=$((TIME_LEFT / 3600))
              echo "ğŸ• í† í° ìœ íš¨ ì‹œê°„: ${HOURS_LEFT}ì‹œê°„"
              echo "auth_valid=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ í† í° ë§Œë£Œë¨"
              echo "auth_valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "existing_auth=false" >> $GITHUB_OUTPUT
            echo "auth_valid=false" >> $GITHUB_OUTPUT
            echo "âŒ OAuth í† í° ì—†ìŒ"
          fi
      
      - name: Reset authentication if requested
        if: github.event.inputs.reset_auth == 'true'
        run: |
          echo "ğŸ”„ ì¸ì¦ ì´ˆê¸°í™” ìš”ì²­ë¨ - ê¸°ì¡´ í† í° ë¬´íš¨í™”"
          echo "reset_requested=true" >> $GITHUB_ENV
      
      - name: Step 1 - Generate OAuth login URL
        if: |
          (steps.auth_check.outputs.existing_auth == 'false') || 
          (steps.auth_check.outputs.auth_valid == 'false') || 
          (github.event.inputs.reset_auth == 'true') && 
          (github.event.inputs.code == '')
        id: login_url
        run: |
          echo "ğŸš€ 1ë‹¨ê³„: Claude OAuth ë¡œê·¸ì¸ URL ìƒì„±"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                        ğŸ” Claude OAuth ì¸ì¦ ì‹œì‘"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼í•˜ì„¸ìš”:"
          echo ""
          echo "1ï¸âƒ£ ì•„ë˜ URLë¡œ ì´ë™í•˜ì—¬ Claudeì— ë¡œê·¸ì¸í•˜ì„¸ìš”:"
          echo "   ğŸ‘‰ https://claude.ai/oauth/login"
          echo ""
          echo "2ï¸âƒ£ ë¡œê·¸ì¸ í›„ ë‚˜íƒ€ë‚˜ëŠ” ì¸ì¦ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì„¸ìš”"
          echo ""
          echo "3ï¸âƒ£ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ë˜, ì´ë²ˆì—” 'code' í•„ë“œì— ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:"
          echo "   â€¢ Actions íƒ­ â†’ 'Claude Code 1íšŒ OAuth ì¸ì¦' â†’ 'Run workflow'"
          echo "   â€¢ 'code' í•„ë“œì— ë³µì‚¬í•œ ì¸ì¦ ì½”ë“œ ì…ë ¥"
          echo "   â€¢ 'Run workflow' í´ë¦­"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  ì£¼ì˜ì‚¬í•­:"
          echo "   â€¢ ì¸ì¦ ì½”ë“œëŠ” 10ë¶„ ì´ë‚´ì— ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤"
          echo "   â€¢ ì½”ë“œëŠ” í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤"
          echo "   â€¢ ì‹¤íŒ¨ ì‹œ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤"
          echo ""
          echo "step=1" >> $GITHUB_OUTPUT
      
      - name: Step 2 - Exchange code for tokens
        if: github.event.inputs.code != ''
        id: token_exchange
        run: |
          echo "ğŸš€ 2ë‹¨ê³„: ì¸ì¦ ì½”ë“œë¥¼ í† í°ìœ¼ë¡œ êµí™˜"
          
          AUTH_CODE="${{ github.event.inputs.code }}"
          
          if [ -z "$AUTH_CODE" ]; then
            echo "âŒ ì¸ì¦ ì½”ë“œê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "ğŸ”„ í† í° êµí™˜ ì¤‘..."
          
          # Claude OAuth í† í° êµí™˜ (ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ëŠ” Claude ë¬¸ì„œ ì°¸ì¡°)
          # ì´ê²ƒì€ ì˜ˆì‹œì…ë‹ˆë‹¤ - ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Claudeì˜ OAuth 2.0 ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=authorization_code&code=$AUTH_CODE&client_id=claude-github-action" || echo "curl_failed")
          
          if [ "$RESPONSE" = "curl_failed" ]; then
            echo "âŒ í† í° êµí™˜ API í˜¸ì¶œ ì‹¤íŒ¨"
            echo "ğŸ“‹ ìˆ˜ë™ ì„¤ì • ì•ˆë‚´:"
            echo "   1. https://claude.ai/settings/oauth ì—ì„œ í† í° ìƒì„±"
            echo "   2. GitHub Secretsì— ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìŒ ê°’ë“¤ ì„¤ì •:"
            echo "      - CLAUDE_ACCESS_TOKEN"
            echo "      - CLAUDE_REFRESH_TOKEN" 
            echo "      - CLAUDE_EXPIRES_AT"
            exit 1
          fi
          
          # JSON íŒŒì‹± (jq í•„ìš”)
          if command -v jq &> /dev/null; then
            ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')
            REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token // empty')
            EXPIRES_IN=$(echo "$RESPONSE" | jq -r '.expires_in // empty')
            
            if [ -n "$ACCESS_TOKEN" ] && [ -n "$REFRESH_TOKEN" ] && [ -n "$EXPIRES_IN" ]; then
              EXPIRES_AT=$(($(date +%s) + $EXPIRES_IN))
              
              echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
              echo "refresh_token=$REFRESH_TOKEN" >> $GITHUB_OUTPUT
              echo "expires_at=$EXPIRES_AT" >> $GITHUB_OUTPUT
              echo "success=true" >> $GITHUB_OUTPUT
              
              echo "âœ… í† í° êµí™˜ ì„±ê³µ!"
              echo "ğŸ• í† í° ë§Œë£Œ ì‹œê°„: $(date -d @$EXPIRES_AT)"
            else
              echo "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ì‘ë‹µ"
              echo "ğŸ“ ì‘ë‹µ: $RESPONSE"
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ jqê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ JSON íŒŒì‹± ë¶ˆê°€"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Store tokens in GitHub Secrets
        if: steps.token_exchange.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { Octokit } = require('@octokit/rest');
            const sodium = require('tweetsodium');
            
            // GitHub Secrets APIëŠ” ì•”í˜¸í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤
            const octokit = new Octokit({
              auth: '${{ secrets.GITHUB_TOKEN }}'
            });
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ê³µê°œ í‚¤ ê°€ì ¸ì˜¤ê¸°
            const { data: publicKey } = await octokit.rest.actions.getRepoPublicKey({
              owner,
              repo,
            });
            
            // í† í° ì•”í˜¸í™” ë° ì €ì¥
            const encryptSecret = (value) => {
              const messageBytes = Buffer.from(value);
              const keyBytes = Buffer.from(publicKey.key, 'base64');
              const encryptedBytes = sodium.seal(messageBytes, keyBytes);
              return Buffer.from(encryptedBytes).toString('base64');
            };
            
            const secrets = [
              {
                name: 'CLAUDE_ACCESS_TOKEN',
                value: '${{ steps.token_exchange.outputs.access_token }}'
              },
              {
                name: 'CLAUDE_REFRESH_TOKEN', 
                value: '${{ steps.token_exchange.outputs.refresh_token }}'
              },
              {
                name: 'CLAUDE_EXPIRES_AT',
                value: '${{ steps.token_exchange.outputs.expires_at }}'
              }
            ];
            
            for (const secret of secrets) {
              try {
                await octokit.rest.actions.createOrUpdateRepoSecret({
                  owner,
                  repo,
                  secret_name: secret.name,
                  encrypted_value: encryptSecret(secret.value),
                  key_id: publicKey.key_id,
                });
                console.log(`âœ… ${secret.name} ì‹œí¬ë¦¿ ì €ì¥ ì™„ë£Œ`);
              } catch (error) {
                console.log(`âŒ ${secret.name} ì‹œí¬ë¦¿ ì €ì¥ ì‹¤íŒ¨:`, error.message);
              }
            }
      
      - name: Verify stored tokens
        if: steps.token_exchange.outputs.success == 'true'
        run: |
          echo "ğŸ” ì €ì¥ëœ í† í° ê²€ì¦..."
          
          # ì ì‹œ ëŒ€ê¸° (GitHub Secrets ì „íŒŒ ì‹œê°„)
          sleep 5
          
          if [ -n "${{ secrets.CLAUDE_ACCESS_TOKEN }}" ]; then
            echo "âœ… CLAUDE_ACCESS_TOKEN ì €ì¥ í™•ì¸ë¨"
          else
            echo "âŒ CLAUDE_ACCESS_TOKEN ì €ì¥ ì‹¤íŒ¨"
          fi
          
          if [ -n "${{ secrets.CLAUDE_REFRESH_TOKEN }}" ]; then
            echo "âœ… CLAUDE_REFRESH_TOKEN ì €ì¥ í™•ì¸ë¨"
          else
            echo "âŒ CLAUDE_REFRESH_TOKEN ì €ì¥ ì‹¤íŒ¨"
          fi
          
          if [ -n "${{ secrets.CLAUDE_EXPIRES_AT }}" ]; then
            echo "âœ… CLAUDE_EXPIRES_AT ì €ì¥ í™•ì¸ë¨"
            EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
            echo "ğŸ• ë§Œë£Œ ì‹œê°„: $(date -d @$EXPIRES_AT)"
          else
            echo "âŒ CLAUDE_EXPIRES_AT ì €ì¥ ì‹¤íŒ¨"
          fi
      
      - name: Setup complete
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    ğŸ‰ Claude OAuth ì„¤ì • ìƒíƒœ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "${{ steps.token_exchange.outputs.success }}" = "true" ]; then
            echo "âœ… Claude OAuth ì¸ì¦ ì™„ë£Œ!"
            echo ""
            echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
            echo "   1. ì´ì œ @claude ë©˜ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            echo "   2. Issueë‚˜ PRì—ì„œ '@claude ë„ì›€ì´ í•„ìš”í•´ìš”' ê°™ì´ ë©˜ì…˜í•˜ì„¸ìš”"
            echo "   3. í† í°ì€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤"
            echo ""
            echo "ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ ì•¡ì…˜:"
            echo "   â€¢ claude-official-action.yml (ê³µì‹ Anthropic ì•¡ì…˜)"
            echo "   â€¢ main-integrated.yml (MCP ë„êµ¬ ì²´ì¸ ë¶„ì„)"
            echo ""
          elif [ "${{ steps.login_url.outputs.step }}" = "1" ]; then
            echo "ğŸ“‹ 1ë‹¨ê³„ ì™„ë£Œ - ì´ì œ ì¸ì¦ ì½”ë“œë¡œ 2ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì„¸ìš”"
            echo ""
            echo "ğŸ”„ ë‹¤ìŒ í•  ì¼:"
            echo "   1. ìœ„ì— í‘œì‹œëœ URLë¡œ ì´ë™í•˜ì—¬ Claude ë¡œê·¸ì¸"
            echo "   2. ì¸ì¦ ì½”ë“œ ë³µì‚¬"  
            echo "   3. ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¸ì¦ ì½”ë“œì™€ í•¨ê»˜ ë‹¤ì‹œ ì‹¤í–‰"
            echo ""
          else
            echo "âš ï¸ OAuth ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo ""
            echo "ğŸ“‹ ë¬¸ì œ í•´ê²°:"
            echo "   â€¢ ìƒˆë¡œìš´ ì¸ì¦ ì½”ë“œë¡œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”"
            echo "   â€¢ ë˜ëŠ” reset_auth=trueë¡œ ì¸ì¦ì„ ì´ˆê¸°í™”í•˜ì„¸ìš”"
            echo ""
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**SafeWork Pro** (건설업 보건관리 시스템) - A comprehensive web application for construction site health management complying with Korean occupational safety and health laws. Manages worker health, medical examinations, workplace monitoring, health education, chemical substances (MSDS), and accident reporting.

### Repository Information
- **GitHub**: qws941/health
- **Registry**: registry.jclee.me/safework:latest
- **Production**: http://192.168.50.215:3001
- **Architecture**: All-in-one container (PostgreSQL + Redis + FastAPI + React)

## Quick Commands

### Development
```bash
# Start development environment
docker-compose -f docker-compose.dev.yml up --build

# Run tests with coverage
pytest tests/ -v --cov=src --cov-report=html --cov-report=term

# Lint and format
black src/ tests/
isort src/ tests/
flake8 src/ tests/

# Frontend development
npm run dev          # Start Vite dev server
npm run build        # Build for production
npm run preview      # Preview production build
```

### Deployment
```bash
# Deploy to production (automated CI/CD)
git add . && git commit -m "feat: description" && git push

# Manual deployment (backup)
./deploy-single.sh

# Check deployment status
curl http://192.168.50.215:3001/health
docker logs safework --tail=50
```

### Database Operations
```bash
# Run migrations
docker exec safework alembic upgrade head

# Create new migration
docker exec safework alembic revision --autogenerate -m "description"

# Database shell
docker exec safework psql -U admin -d health_management
```

## Architecture

### System Architecture
```
┌──────────────────────────────────────┐
│         All-in-One Container         │
│  ┌─────────┐  ┌─────────┐  ┌──────┐ │
│  │ React   │──│ FastAPI │──│ PG   │ │
│  │ (Nginx) │  │ Backend │  │ DB   │ │
│  └─────────┘  └────┬────┘  └──────┘ │
│                    │                 │
│                ┌───┴───┐             │
│                │ Redis │             │
│                └───────┘             │
└──────────────────────────────────────┘
         Port 3001 (External)
```

### Code Structure

#### Backend (`src/`)
- `app.py` - FastAPI application factory with middleware stack
- `models/` - SQLAlchemy models with Korean industry enums
- `schemas/` - Pydantic validation schemas
- `handlers/` - API endpoints organized by domain
- `middleware/` - Security, caching, logging, performance layers
- `services/` - Business logic and external integrations
- `utils/` - Helper functions and utilities

#### Frontend (`src/`)
- `App.tsx` - Main React application with sidebar navigation
- `components/` - Reusable UI components
- `pages/` - Feature-specific page components
- `api/` - Backend API integration layer

#### Key Middleware Stack
1. **Security**: CSRF, XSS, SQL injection protection
2. **Caching**: Redis-backed response caching
3. **Logging**: Structured logging with metrics
4. **Performance**: Compression, rate limiting
5. **Auth**: JWT with role-based access control

## Development Guidelines

### Adding New Features
1. Define database model in `src/models/`
2. Create Pydantic schema in `src/schemas/`
3. Implement API handler in `src/handlers/`
4. Update frontend in React components
5. Write tests with >80% coverage
6. Update API documentation

### Database Schema Patterns
```python
# Model (src/models/worker.py)
class Worker(Base):
    gender = Column(String(10), nullable=True)  # Optional
    employment_type = Column(String(20), nullable=False)  # Required

# Schema (src/schemas/worker.py)
class WorkerCreate(BaseModel):
    gender: Optional[str] = None  # Match nullable
    employment_type: str  # Match required
```

### PDF Form Development
1. Add PDF template to `document/`
2. Define coordinates in `PDF_FORM_COORDINATES` (src/handlers/documents.py)
3. Update form selector in frontend
4. Test with Korean font rendering

### Testing Strategy
- **Unit Tests**: Individual functions and classes
- **Integration Tests**: API endpoints with database
- **Performance Tests**: Load and response time
- **Security Tests**: Vulnerability scanning
- **Coverage Target**: Minimum 80%

## Deployment Pipeline

### CI/CD Flow
```
Developer Push → GitHub Actions → Build & Test → Push to Registry → Watchtower → Auto Deploy
```

### GitHub Actions Workflows
- `build-deploy.yml` - Main CI/CD pipeline
- `test.yml` - Automated testing
- `security.yml` - Security scanning
- `health-monitor.yml` - Production monitoring

### Environment Variables
```bash
# Required for production
DATABASE_URL=postgresql://admin:password@localhost:5432/health_management
REDIS_URL=redis://localhost:6379/0
JWT_SECRET=<secure-random-string>
BUILD_TIME=<auto-generated>
TZ=Asia/Seoul
```

## Domain-Specific Context

### Korean Construction Industry Compliance
- **Health Exams**: Annual general + special for hazardous exposure
- **Environment Monitoring**: Bi-annual measurements (noise, dust, chemicals)
- **Education**: 8 hours initial, 3 hours quarterly
- **MSDS Management**: Chemical substance documentation
- **Accident Reporting**: Government compliance forms

### Supported PDF Forms
1. **유소견자 관리대장** - Worker health findings ledger
2. **MSDS 관리대장** - Chemical safety data ledger
3. **건강관리 상담방문 일지** - Health consultation log
4. **특별관리물질 취급일지** - Special substance handling log

## Common Issues & Solutions

### Development Issues
| Issue | Solution |
|-------|----------|
| UI not updating | Clear browser cache, check dist/ mount |
| Database connection failed | Wait for container health check |
| CORS errors | Verify API_BASE_URL configuration |
| Korean text garbled | Check ko_KR.UTF-8 locale in PostgreSQL |
| PDF positioning wrong | Adjust coordinates in PDF_FORM_COORDINATES |

### Production Debugging
```bash
# Container health
docker ps | grep safework
curl http://192.168.50.215:3001/health

# Logs
docker logs safework --tail=100 | grep ERROR
journalctl -u docker -f

# Database
docker exec safework psql -U admin -d health_management -c "\dt"

# Force restart
docker restart safework
```

## Performance Optimization

### Current Optimizations
- Redis caching for API responses and sessions
- Database connection pooling (pool_size=10)
- Gzip compression for responses
- Frontend code splitting with Vite
- Docker multi-stage builds with layer caching

### Monitoring Endpoints
- `/health` - Basic health check
- `/api/v1/monitoring/metrics` - Prometheus metrics
- `/api/v1/monitoring/ws` - Real-time WebSocket monitoring

## Security Measures

### Implemented Security
- JWT authentication with refresh tokens
- HTTPS enforcement in production
- SQL injection protection via SQLAlchemy
- XSS prevention with content security policy
- Rate limiting (100 requests/minute)
- API key authentication for external services
- Automated security scanning via Trivy

### Security Headers
```python
# Automatically applied via middleware
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000
```

---
**Version**: 2.0.0  
**Updated**: 2025-06-26  
**Maintainer**: SafeWork Pro Development Team  
**CI/CD Status**: ✅ Active (GitHub Actions + Watchtower)